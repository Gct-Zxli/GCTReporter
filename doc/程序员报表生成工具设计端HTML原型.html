<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¨‹åºå‘˜æŠ¥è¡¨ç”Ÿæˆå·¥å…· - è®¾è®¡ç«¯</title>
    <style>
        /* ========== CSSå˜é‡å®šä¹‰ ========== */
        :root {
            --primary-color: #0066CC;
            --primary-hover: #0052A3;
            --primary-active: #003D7A;
            --success-color: #52c41a;
            --warning-color: #faad14;
            --error-color: #f5222d;
            --info-color: #1890ff;
            --text-primary: #262626;
            --text-secondary: #595959;
            --text-disabled: #bfbfbf;
            --bg-primary: #ffffff;
            --bg-secondary: #fafafa;
            --border-color: #d9d9d9;
            --border-radius: 4px;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-md: 0 2px 8px rgba(0,0,0,0.12);
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
        }

        /* ========== å…¨å±€æ ·å¼ ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            font-size: 14px;
            color: var(--text-primary);
            background: var(--bg-secondary);
            line-height: 1.5;
        }

        /* ========== ä¸»å®¹å™¨å¸ƒå±€ ========== */
        .page-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 200px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            padding: var(--spacing-md);
            overflow-y: auto;
            box-shadow: var(--shadow-sm);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }

        .content {
            flex: 1;
            padding: var(--spacing-lg);
            overflow-y: auto;
        }

        /* ========== å¤´éƒ¨æ ·å¼ ========== */
        .header-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: var(--spacing-md);
        }

        /* ========== ä¾§è¾¹æ æ ·å¼ ========== */
        .nav-item {
            padding: var(--spacing-sm) var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            cursor: pointer;
            border-radius: var(--border-radius);
            color: var(--text-primary);
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .nav-item:hover {
            background: var(--bg-secondary);
            color: var(--primary-color);
        }

        .nav-item.active {
            background: #e6f7ff;
            color: var(--primary-color);
            font-weight: 600;
            border-left: 3px solid var(--primary-color);
            padding-left: calc(var(--spacing-md) - 3px);
        }

        /* ========== æ ‡ç­¾é¡µæ ·å¼ ========== */
        .tabs {
            display: flex;
            gap: var(--spacing-sm);
            border-bottom: 2px solid var(--border-color);
            margin-bottom: var(--spacing-lg);
        }

        .tab {
            padding: var(--spacing-md) var(--spacing-lg);
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .tab:hover {
            color: var(--primary-color);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }

        /* ========== å¡ç‰‡æ ·å¼ ========== */
        .card {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
        }

        /* ========== æŒ‰é’®æ ·å¼ ========== */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:active:not(:disabled) {
            background: var(--primary-active);
        }

        .btn-primary:disabled {
            background: var(--text-disabled);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .btn-danger {
            background: var(--error-color);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            opacity: 0.8;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-loading {
            position: relative;
            color: transparent;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* ========== è¾“å…¥æ¡†æ ·å¼ ========== */
        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: var(--spacing-sm);
            color: var(--text-primary);
        }

        .form-label.required::after {
            content: ' *';
            color: var(--error-color);
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
            background: var(--bg-primary);
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.1);
        }

        .form-input:disabled,
        .form-textarea:disabled,
        .form-select:disabled {
            background: var(--bg-secondary);
            color: var(--text-disabled);
            cursor: not-allowed;
        }

        .form-input.error,
        .form-textarea.error,
        .form-select.error {
            border-color: var(--error-color);
            background: rgba(245, 34, 45, 0.05);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-hint {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: var(--spacing-xs);
        }

        .form-error {
            font-size: 12px;
            color: var(--error-color);
            margin-top: var(--spacing-xs);
        }

        /* ========== ä»£ç ç¼–è¾‘å™¨æ ·å¼ ========== */
        .code-editor {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            background: var(--bg-primary);
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
        }

        .code-editor textarea {
            width: 100%;
            height: 300px;
            padding: var(--spacing-md);
            border: none;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: inherit;
            resize: none;
        }

        /* ========== è¡¨æ ¼æ ·å¼ ========== */
        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .table thead {
            background: var(--bg-secondary);
        }

        .table th {
            padding: var(--spacing-sm) var(--spacing-md);
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            color: var(--text-primary);
        }

        .table td {
            padding: var(--spacing-sm) var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }

        .table tbody tr:hover {
            background: var(--bg-secondary);
        }

        /* ========== æ¶ˆæ¯æç¤ºæ ·å¼ ========== */
        .toast-container {
            position: fixed;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            max-width: 400px;
        }

        .toast {
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            font-size: 14px;
            line-height: 1.5;
        }

        .toast.success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #274e2b;
        }

        .toast.error {
            background: #fff1f0;
            border: 1px solid #ffccc7;
            color: #58181c;
        }

        .toast.warning {
            background: #fffbe6;
            border: 1px solid #ffe58f;
            color: #684d0d;
        }

        .toast.info {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            color: #0c3c26;
        }

        .toast-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .toast-close {
            margin-left: auto;
            cursor: pointer;
            opacity: 0.5;
            flex-shrink: 0;
        }

        .toast-close:hover {
            opacity: 1;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ========== æ¨¡æ€å¯¹è¯æ¡†æ ·å¼ ========== */
        .modal-mask {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
            animation: fadeIn 0.2s ease;
        }

        .modal-mask.show {
            display: flex;
        }

        .modal {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            max-width: 500px;
            width: 90%;
            animation: zoomIn 0.2s ease;
        }

        .modal-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            font-size: 16px;
            font-weight: 600;
        }

        .modal-body {
            padding: var(--spacing-lg);
            font-size: 14px;
            line-height: 1.6;
        }

        .modal-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes zoomIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* ========== çŠ¶æ€æŒ‡ç¤ºå™¨ ========== */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.success {
            background: #f6ffed;
            color: #274e2b;
            border: 1px solid #b7eb8f;
        }

        .status-badge.error {
            background: #fff1f0;
            color: #58181c;
            border: 1px solid #ffccc7;
        }

        .status-badge.warning {
            background: #fffbe6;
            color: #684d0d;
            border: 1px solid #ffe58f;
        }

        .status-badge.processing {
            background: #e6f7ff;
            color: #0c3c26;
            border: 1px solid #91d5ff;
        }

        /* ========== è¡Œæ“ä½œåŒºåŸŸ ========== */
        .row-actions {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
        }

        /* ========== å¸ƒå±€å·¥å…·ç±» ========== */
        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .flex-1 {
            flex: 1;
        }

        .gap-sm {
            gap: var(--spacing-sm);
        }

        .gap-md {
            gap: var(--spacing-md);
        }

        .mt-md {
            margin-top: var(--spacing-md);
        }

        .mb-md {
            margin-bottom: var(--spacing-md);
        }

        .hidden {
            display: none;
        }

        /* ========== å“åº”å¼è®¾è®¡ ========== */
        @media (max-width: 1280px) {
            .sidebar {
                width: 160px;
            }

            .main-content {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <!-- ========== ä¸»å®¹å™¨ ========== -->
    <div class="page-container">
        <!-- ========== ä¾§è¾¹æ å¯¼èˆª ========== -->
        <div class="sidebar">
            <div style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-lg); color: var(--primary-color);">ğŸ“Š æŠ¥è¡¨è®¾è®¡</div>
            <div class="nav-item active" data-tab="sql">
                <span>ğŸ”§ SQLç¼–å†™</span>
            </div>
            <div class="nav-item" data-tab="params">
                <span>âš™ï¸ å‚æ•°å®šä¹‰</span>
            </div>
            <div class="nav-item" data-tab="test">
                <span>ğŸ§ª æµ‹è¯•æŸ¥è¯¢</span>
            </div>
            <div class="nav-item" data-tab="columns">
                <span>ğŸ“‹ åˆ—é…ç½®</span>
            </div>
            <div class="nav-item" data-tab="format">
                <span>ğŸ¨ æ ¼å¼åŒ–</span>
            </div>
        </div>

        <!-- ========== ä¸»å†…å®¹åŒºåŸŸ ========== -->
        <div class="main-content">
            <!-- ========== é¡µé¢å¤´éƒ¨ ========== -->
            <div class="header">
                <div>
                    <div class="header-title">è®¾è®¡ç«¯ - æŠ¥è¡¨ç¼–è¾‘</div>
                    <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">SQLç¼–å†™ â†’ å‚æ•°å®šä¹‰ â†’ æµ‹è¯•æŸ¥è¯¢ â†’ åˆ—é…ç½® â†’ æ ¼å¼åŒ–</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" id="resetBtn" onclick="resetForm()">
                        ğŸ”„ é‡ç½®
                    </button>
                    <button class="btn btn-primary" id="saveBtn" onclick="saveReport()">
                        ğŸ’¾ ä¿å­˜æŠ¥è¡¨
                    </button>
                </div>
            </div>

            <!-- ========== å†…å®¹åŒºåŸŸ ========== -->
            <div class="content">
                <!-- ===== SQLç¼–å†™Tab ===== -->
                <div id="tab-sql" class="tab-pane active">
                    <div class="card">
                        <div class="card-title">ğŸ“ SQLç¼–è¾‘å™¨</div>
                        <div class="code-editor">
                            <textarea id="sqlInput" placeholder="è¾“å…¥SQLè¯­å¥...
ä¾‹å¦‚ï¼šSELECT id, name, age, salary FROM employees WHERE department_id = #{deptId}"></textarea>
                        </div>
                        <div id="sqlValidation" class="form-hint" style="margin-top: var(--spacing-md);">
                            â³ è¾“å…¥å®Œæˆåè‡ªåŠ¨éªŒè¯å®‰å…¨æ€§...
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">ğŸ’¡ æ“ä½œæç¤º</div>
                        <ul style="list-style: none; padding: 0;">
                            <li style="padding: var(--spacing-xs) 0;">âœ“ åœ¨SQLä¸­ä½¿ç”¨å‚æ•°å ä½ç¬¦ï¼š#{paramName}</li>
                            <li style="padding: var(--spacing-xs) 0;">âœ“ å»ºè®®ä»…ä½¿ç”¨SELECTè¯­å¥</li>
                            <li style="padding: var(--spacing-xs) 0;">âœ“ å¿«æ·é”®ï¼šCtrl+Sä¿å­˜ï¼ŒCtrl+Shift+Fæ ¼å¼åŒ–</li>
                        </ul>
                    </div>
                </div>

                <!-- ===== å‚æ•°å®šä¹‰Tab ===== -->
                <div id="tab-params" class="tab-pane hidden">
                    <div class="card">
                        <div class="card-title">âš™ï¸ æŸ¥è¯¢å‚æ•°</div>
                        <button class="btn btn-primary mb-md" id="addParamBtn" onclick="addParameter()">
                            â• æ–°å¢å‚æ•°
                        </button>
                        <table class="table" id="paramsTable">
                            <thead>
                                <tr>
                                    <th>å‚æ•°å</th>
                                    <th>ç±»å‹</th>
                                    <th>é»˜è®¤å€¼</th>
                                    <th>å¿…å¡«</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="paramsBody">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: var(--text-secondary);">
                                        æš‚æ— å‚æ•°ï¼Œç‚¹å‡»"æ–°å¢å‚æ•°"æ·»åŠ 
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="card">
                        <div class="card-title">ğŸ“– å‚æ•°ç±»å‹è¯´æ˜</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                            <div>
                                <strong>String</strong>: å­—ç¬¦ä¸²ï¼Œå¦‚"åŒ—äº¬"
                            </div>
                            <div>
                                <strong>Integer</strong>: æ•´æ•°ï¼Œå¦‚2025
                            </div>
                            <div>
                                <strong>Date</strong>: æ—¥æœŸï¼Œå¦‚2025-12-26
                            </div>
                            <div>
                                <strong>Decimal</strong>: å°æ•°ï¼Œå¦‚99.99
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== æµ‹è¯•æŸ¥è¯¢Tab ===== -->
                <div id="tab-test" class="tab-pane hidden">
                    <div class="card">
                        <div class="card-title">ğŸ§ª æµ‹è¯•å‚æ•°</div>
                        <div id="testParamsForm"></div>
                        <button class="btn btn-primary mt-md" id="executeBtn" onclick="executeQuery()" disabled>
                            âš¡ æ‰§è¡ŒæŸ¥è¯¢
                        </button>
                    </div>

                    <div class="card mt-md">
                        <div class="card-title">ğŸ“Š æŸ¥è¯¢ç»“æœ</div>
                        <div id="queryResult" style="color: var(--text-secondary); text-align: center; padding: var(--spacing-lg);">
                            å°šæœªæ‰§è¡ŒæŸ¥è¯¢
                        </div>
                    </div>
                </div>

                <!-- ===== åˆ—é…ç½®Tab ===== -->
                <div id="tab-columns" class="tab-pane hidden">
                    <div class="card">
                        <div class="card-title">ğŸ“‹ åˆ—é…ç½®</div>
                        <div id="columnsConfig" style="color: var(--text-secondary); text-align: center; padding: var(--spacing-lg);">
                            è¯·å…ˆæ‰§è¡Œæµ‹è¯•æŸ¥è¯¢ä»¥åŠ è½½åˆ—ä¿¡æ¯
                        </div>
                        <button class="btn btn-primary mt-md hidden" id="saveColumnsBtn" onclick="saveColumnsConfig()">
                            ğŸ’¾ ä¿å­˜åˆ—é…ç½®
                        </button>
                    </div>
                </div>

                <!-- ===== æ ¼å¼åŒ–Tab ===== -->
                <div id="tab-format" class="tab-pane hidden">
                    <div class="card">
                        <div class="card-title">ğŸ¨ æ•°æ®æ ¼å¼åŒ–</div>
                        <div id="formatConfig" style="color: var(--text-secondary); text-align: center; padding: var(--spacing-lg);">
                            è¯·å…ˆæ‰§è¡Œæµ‹è¯•æŸ¥è¯¢ä»¥åŠ è½½åˆ—ä¿¡æ¯
                        </div>
                        <button class="btn btn-primary mt-md hidden" id="saveFormatBtn" onclick="saveFormatConfig()">
                            ğŸ’¾ ä¿å­˜æ ¼å¼åŒ–é…ç½®
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== Toastæç¤ºå®¹å™¨ ========== -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- ========== åˆ é™¤ç¡®è®¤å¯¹è¯æ¡† ========== -->
    <div id="confirmModal" class="modal-mask">
        <div class="modal">
            <div class="modal-header">ç¡®è®¤åˆ é™¤</div>
            <div class="modal-body">
                ç¡®å®šè¦åˆ é™¤æ­¤æŠ¥è¡¨å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-danger" onclick="confirmDelete()">åˆ é™¤</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // å…¨å±€çŠ¶æ€ç®¡ç†
        // ========================================

        const appState = {
            // æŠ¥è¡¨ä¿¡æ¯
            reportId: null,
            reportName: 'æ–°å»ºæŠ¥è¡¨',
            sql: localStorage.getItem('draft_sql') || '',
            parameters: JSON.parse(localStorage.getItem('draft_params') || '[]'),
            columns: [],
            queryResult: null,

            // é…ç½®
            columnConfig: JSON.parse(localStorage.getItem('column_config') || '{}'),
            formatConfig: JSON.parse(localStorage.getItem('format_config') || '{}'),

            // UIçŠ¶æ€
            activeTab: 'sql',
            isLoading: false,
        };

        // ========================================
        // å·¥å…·å‡½æ•°
        // ========================================

        /**
         * é˜²æŠ–å‡½æ•°
         * @param {Function} fn è¦æ‰§è¡Œçš„å‡½æ•°
         * @param {number} delay å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
         */
        function debounce(fn, delay) {
            let timer = null;
            return function(...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        /**
         * æ˜¾ç¤ºToastæç¤º
         * @param {string} message æç¤ºå†…å®¹
         * @param {string} type ç±»å‹ï¼šsuccess/error/warning/info
         * @param {number} duration æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
         */
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const iconMap = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸',
            };

            toast.innerHTML = `
                <span class="toast-icon">${iconMap[type]}</span>
                <span>${message}</span>
                <span class="toast-close" onclick="this.parentElement.remove()">âœ•</span>
            `;

            container.appendChild(toast);

            if (duration > 0) {
                setTimeout(() => {
                    toast.style.animation = 'slideIn 0.3s ease reverse';
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
        }

        /**
         * æ‰“å¼€ç¡®è®¤å¯¹è¯æ¡†
         */
        function openModal() {
            document.getElementById('confirmModal').classList.add('show');
        }

        /**
         * å…³é—­ç¡®è®¤å¯¹è¯æ¡†
         */
        function closeModal() {
            document.getElementById('confirmModal').classList.remove('show');
        }

        /**
         * éªŒè¯SQLï¼ˆæ¨¡æ‹Ÿï¼‰
         */
        function validateSQL() {
            const sql = document.getElementById('sqlInput').value.trim();
            const validationEl = document.getElementById('sqlValidation');

            if (!sql) {
                validationEl.innerHTML = 'â³ è¾“å…¥SQLè¯­å¥åå°†è‡ªåŠ¨éªŒè¯...';
                return;
            }

            validationEl.innerHTML = 'â³ æ­£åœ¨éªŒè¯SQLå®‰å…¨æ€§...';

            // æ¨¡æ‹ŸéªŒè¯å»¶è¿Ÿ
            setTimeout(() => {
                // æ£€æŸ¥å±é™©å…³é”®å­—
                const dangerousKeywords = ['DROP', 'DELETE', 'TRUNCATE', 'ALTER'];
                const hasDangerous = dangerousKeywords.some(keyword =>
                    sql.toUpperCase().includes(keyword)
                );

                if (hasDangerous) {
                    validationEl.className = 'form-error';
                    validationEl.innerHTML = 'âŒ æ£€æµ‹åˆ°å±é™©å…³é”®å­—ï¼šè¯·ä»…ä½¿ç”¨SELECTè¯­å¥';
                    document.getElementById('executeBtn').disabled = true;
                } else if (sql.length > 10000) {
                    validationEl.className = 'form-hint';
                    validationEl.innerHTML = 'âš ï¸ è­¦å‘Šï¼šSQLé•¿åº¦è¶…è¿‡é™åˆ¶ï¼ˆå½“å‰ï¼š' + sql.length + 'å­—ç¬¦ï¼‰';
                    document.getElementById('executeBtn').disabled = false;
                } else {
                    validationEl.className = 'form-hint';
                    validationEl.style.color = 'var(--success-color)';
                    validationEl.innerHTML = 'âœ… å®‰å…¨é€šè¿‡ - æ­¤SQLè¯­å¥å¯ä»¥å®‰å…¨æ‰§è¡Œ';
                    document.getElementById('executeBtn').disabled = false;
                }
            }, 800);
        }

        // ç›‘å¬SQLè¾“å…¥å˜åŒ–
        const sqlInput = document.getElementById('sqlInput');
        sqlInput.value = appState.sql;
        sqlInput.addEventListener('input', debounce(function() {
            appState.sql = this.value;
            localStorage.setItem('draft_sql', this.value);
            validateSQL();
        }, 200));

        // é¡µé¢åŠ è½½æ—¶éªŒè¯SQL
        if (appState.sql) {
            validateSQL();
        }

        /**
         * æ·»åŠ å‚æ•°
         */
        function addParameter() {
            const param = {
                id: 'param_' + Date.now(),
                name: '',
                type: 'String',
                defaultValue: '',
                required: false,
            };

            appState.parameters.push(param);
            renderParametersTable();
        }

        /**
         * åˆ é™¤å‚æ•°
         */
        function deleteParameter(id) {
            appState.parameters = appState.parameters.filter(p => p.id !== id);
            renderParametersTable();
        }

        /**
         * æ›´æ–°å‚æ•°
         */
        function updateParameter(id, field, value) {
            const param = appState.parameters.find(p => p.id === id);
            if (param) {
                param[field] = value;
                saveParameters();
                renderParametersTable();
            }
        }

        /**
         * æ¸²æŸ“å‚æ•°è¡¨æ ¼
         */
        function renderParametersTable() {
            const tbody = document.getElementById('paramsBody');

            if (appState.parameters.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: var(--text-secondary);">
                            æš‚æ— å‚æ•°ï¼Œç‚¹å‡»"æ–°å¢å‚æ•°"æ·»åŠ 
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = appState.parameters.map(param => `
                <tr>
                    <td>
                        <input type="text" class="form-input" style="width: 100%;" value="${param.name}"
                            onchange="updateParameter('${param.id}', 'name', this.value)"
                            placeholder="å‚æ•°å">
                    </td>
                    <td>
                        <select class="form-select" onchange="updateParameter('${param.id}', 'type', this.value)">
                            <option value="String" ${param.type === 'String' ? 'selected' : ''}>String</option>
                            <option value="Integer" ${param.type === 'Integer' ? 'selected' : ''}>Integer</option>
                            <option value="Date" ${param.type === 'Date' ? 'selected' : ''}>Date</option>
                            <option value="Decimal" ${param.type === 'Decimal' ? 'selected' : ''}>Decimal</option>
                        </select>
                    </td>
                    <td>
                        <input type="text" class="form-input" style="width: 100%;" value="${param.defaultValue}"
                            onchange="updateParameter('${param.id}', 'defaultValue', this.value)"
                            placeholder="é»˜è®¤å€¼">
                    </td>
                    <td style="text-align: center;">
                        <input type="checkbox" ${param.required ? 'checked' : ''}
                            onchange="updateParameter('${param.id}', 'required', this.checked)">
                    </td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteParameter('${param.id}')">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        /**
         * ä¿å­˜å‚æ•°åˆ°æœ¬åœ°å­˜å‚¨
         */
        function saveParameters() {
            localStorage.setItem('draft_params', JSON.stringify(appState.parameters));
        }

        /**
         * æ‰§è¡Œæµ‹è¯•æŸ¥è¯¢
         */
        function executeQuery() {
            const executeBtn = document.getElementById('executeBtn');
            const resultEl = document.getElementById('queryResult');

            // æ£€æŸ¥å‚æ•°éªŒè¯
            const testForm = document.getElementById('testParamsForm');
            const requiredParams = appState.parameters.filter(p => p.required);
            for (let param of requiredParams) {
                const input = testForm.querySelector(`[name="${param.id}"]`);
                if (!input || !input.value) {
                    showToast(`å¿…å¡«å‚æ•° "${param.name}" æœªå¡«å†™`, 'error');
                    return;
                }
            }

            // è®¾ç½®loadingçŠ¶æ€
            executeBtn.classList.add('btn-loading');
            executeBtn.disabled = true;
            resultEl.innerHTML = 'â³ æ­£åœ¨æ‰§è¡ŒæŸ¥è¯¢ï¼Œè¯·ç­‰å€™...';

            // æ¨¡æ‹ŸæŸ¥è¯¢å»¶è¿Ÿ
            setTimeout(() => {
                // ç”Ÿæˆæ¨¡æ‹Ÿç»“æœ
                const mockColumns = ['ID', 'Name', 'Age', 'Salary', 'Department'];
                const mockRows = [
                    { ID: 1, Name: 'å¼ ä¸‰', Age: 28, Salary: 15000, Department: 'æŠ€æœ¯éƒ¨' },
                    { ID: 2, Name: 'æå››', Age: 32, Salary: 18000, Department: 'æŠ€æœ¯éƒ¨' },
                    { ID: 3, Name: 'ç‹äº”', Age: 26, Salary: 12000, Department: 'å¸‚åœºéƒ¨' },
                ];

                appState.columns = mockColumns;
                appState.queryResult = mockRows;

                // æ¸²æŸ“ç»“æœè¡¨æ ¼
                const tableHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                ${mockColumns.map(col => `<th>${col}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${mockRows.map(row => `
                                <tr>
                                    ${mockColumns.map(col => `<td>${row[col]}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <p style="margin-top: var(--spacing-md); color: var(--text-secondary);">
                        âœ… æŸ¥è¯¢æ‰§è¡ŒæˆåŠŸ | è€—æ—¶ï¼š0.32ç§’ | è¿”å›è¡Œæ•°ï¼š${mockRows.length}
                    </p>
                `;

                resultEl.innerHTML = tableHTML;

                // æ›´æ–°åˆ—é…ç½®å’Œæ ¼å¼åŒ–é€‰é¡¹
                updateColumnOptions();
                updateFormatOptions();

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                executeBtn.classList.remove('btn-loading');
                executeBtn.disabled = false;

                showToast('æŸ¥è¯¢æ‰§è¡ŒæˆåŠŸ', 'success');
            }, 2000);
        }

        /**
         * æ›´æ–°åˆ—é…ç½®é€‰é¡¹
         */
        function updateColumnOptions() {
            const configEl = document.getElementById('columnsConfig');
            const saveBtn = document.getElementById('saveColumnsBtn');

            configEl.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>åˆ—å</th>
                            <th>æ˜¾ç¤ºåç§°</th>
                            <th>å¯è§</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appState.columns.map((col, idx) => `
                            <tr>
                                <td>${col}</td>
                                <td>
                                    <input type="text" class="form-input" style="width: 100%; padding: 4px 8px;"
                                        value="${appState.columnConfig[col]?.displayName || col}"
                                        onchange="updateColumnConfig('${col}', 'displayName', this.value)">
                                </td>
                                <td style="text-align: center;">
                                    <input type="checkbox" checked
                                        onchange="updateColumnConfig('${col}', 'visible', this.checked)">
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-secondary">ç¼–è¾‘</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            saveBtn.classList.remove('hidden');
        }

        /**
         * æ›´æ–°åˆ—é…ç½®
         */
        function updateColumnConfig(col, field, value) {
            if (!appState.columnConfig[col]) {
                appState.columnConfig[col] = {};
            }
            appState.columnConfig[col][field] = value;
        }

        /**
         * ä¿å­˜åˆ—é…ç½®
         */
        function saveColumnsConfig() {
            localStorage.setItem('column_config', JSON.stringify(appState.columnConfig));
            showToast('åˆ—é…ç½®å·²ä¿å­˜', 'success');
        }

        /**
         * æ›´æ–°æ ¼å¼åŒ–é€‰é¡¹
         */
        function updateFormatOptions() {
            const configEl = document.getElementById('formatConfig');
            const saveBtn = document.getElementById('saveFormatBtn');

            configEl.innerHTML = `
                <div style="text-align: left;">
                    <div class="form-group">
                        <label class="form-label">é€‰æ‹©è¦æ ¼å¼åŒ–çš„åˆ—</label>
                        <select class="form-select" onchange="updateFormatColumn(this.value)">
                            <option value="">-- è¯·é€‰æ‹©åˆ— --</option>
                            ${appState.columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                        </select>
                    </div>

                    <div id="formatOptions" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">æ ¼å¼ç±»å‹</label>
                            <select class="form-select" onchange="updateFormatType(this.value)">
                                <option value="">-- è¯·é€‰æ‹© --</option>
                                <option value="date">æ—¥æœŸæ ¼å¼</option>
                                <option value="number">æ•°å­—æ ¼å¼</option>
                                <option value="currency">è´§å¸æ ¼å¼</option>
                                <option value="percent">ç™¾åˆ†æ¯”æ ¼å¼</option>
                            </select>
                        </div>

                        <div id="formatDetail"></div>

                        <div style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--border-radius);">
                            <strong>é¢„è§ˆï¼š</strong>
                            <span id="formatPreview" style="font-family: monospace;">-</span>
                        </div>
                    </div>
                </div>
            `;

            saveBtn.classList.remove('hidden');
        }

        /**
         * æ›´æ–°æ ¼å¼åŒ–åˆ—
         */
        function updateFormatColumn(col) {
            const optionsEl = document.getElementById('formatOptions');
            if (col) {
                optionsEl.style.display = 'block';
            } else {
                optionsEl.style.display = 'none';
            }
        }

        /**
         * æ›´æ–°æ ¼å¼ç±»å‹
         */
        function updateFormatType(type) {
            const detailEl = document.getElementById('formatDetail');
            const previewEl = document.getElementById('formatPreview');

            if (type === 'date') {
                detailEl.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">æ—¥æœŸæ ¼å¼</label>
                        <select class="form-select" onchange="updateFormatPreview()">
                            <option value="yyyy-MM-dd">yyyy-MM-dd</option>
                            <option value="yyyy/MM/dd">yyyy/MM/dd</option>
                            <option value="MM-dd">MM-dd</option>
                        </select>
                    </div>
                `;
                previewEl.textContent = '2025-12-26';
            } else if (type === 'number') {
                detailEl.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">å°æ•°ä½æ•°</label>
                        <input type="number" class="form-input" min="0" max="4" value="2" onchange="updateFormatPreview()">
                    </div>
                `;
                previewEl.textContent = '1,234.56';
            } else if (type === 'currency') {
                detailEl.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">è´§å¸ç¬¦å·</label>
                        <select class="form-select" onchange="updateFormatPreview()">
                            <option value="Â¥">äººæ°‘å¸ Â¥</option>
                            <option value="$">ç¾å…ƒ $</option>
                            <option value="â‚¬">æ¬§å…ƒ â‚¬</option>
                        </select>
                    </div>
                `;
                previewEl.textContent = 'Â¥1,234.56';
            } else if (type === 'percent') {
                detailEl.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">å°æ•°ä½æ•°</label>
                        <input type="number" class="form-input" min="0" max="2" value="2" onchange="updateFormatPreview()">
                    </div>
                `;
                previewEl.textContent = '98.50%';
            }
        }

        /**
         * æ›´æ–°æ ¼å¼é¢„è§ˆ
         */
        function updateFormatPreview() {
            // é¢„è§ˆæ›´æ–°é€»è¾‘
        }

        /**
         * ä¿å­˜æ ¼å¼åŒ–é…ç½®
         */
        function saveFormatConfig() {
            localStorage.setItem('format_config', JSON.stringify(appState.formatConfig));
            showToast('æ ¼å¼åŒ–é…ç½®å·²ä¿å­˜', 'success');
        }

        /**
         * é‡ç½®è¡¨å•
         */
        function resetForm() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è¡¨å•æ•°æ®å—ï¼Ÿ')) {
                appState.sql = '';
                appState.parameters = [];
                appState.queryResult = null;
                appState.columns = [];

                document.getElementById('sqlInput').value = '';
                document.getElementById('paramsBody').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: var(--text-secondary);">
                            æš‚æ— å‚æ•°ï¼Œç‚¹å‡»"æ–°å¢å‚æ•°"æ·»åŠ 
                        </td>
                    </tr>
                `;

                localStorage.removeItem('draft_sql');
                localStorage.removeItem('draft_params');

                showToast('è¡¨å•å·²é‡ç½®', 'info');
            }
        }

        /**
         * ä¿å­˜æŠ¥è¡¨
         */
        function saveReport() {
            if (!appState.sql.trim()) {
                showToast('è¯·å…ˆè¾“å…¥SQLè¯­å¥', 'warning');
                return;
            }

            const saveBtn = document.getElementById('saveBtn');
            saveBtn.classList.add('btn-loading');
            saveBtn.disabled = true;

            // æ¨¡æ‹Ÿä¿å­˜å»¶è¿Ÿ
            setTimeout(() => {
                saveBtn.classList.remove('btn-loading');
                saveBtn.disabled = false;

                showToast('æŠ¥è¡¨å·²ä¿å­˜æˆåŠŸ', 'success');
            }, 1000);
        }

        /**
         * ç¡®è®¤åˆ é™¤
         */
        function confirmDelete() {
            closeModal();
            showToast('æŠ¥è¡¨å·²åˆ é™¤', 'success');
        }

        // ========================================
        // Tabé¡µé¢åˆ‡æ¢
        // ========================================

        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                const tabName = this.dataset.tab;

                // æ›´æ–°å¯¼èˆªçŠ¶æ€
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                this.classList.add('active');

                // éšè—æ‰€æœ‰æ ‡ç­¾é¡µ
                document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('hidden'));

                // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
                const targetTab = document.getElementById(`tab-${tabName}`);
                if (targetTab) {
                    targetTab.classList.remove('hidden');
                }

                // ç”Ÿæˆæµ‹è¯•è¡¨å•
                if (tabName === 'test' && document.getElementById('testParamsForm').innerHTML === '') {
                    renderTestForm();
                }

                appState.activeTab = tabName;
            });
        });

        /**
         * æ¸²æŸ“æµ‹è¯•å‚æ•°è¡¨å•
         */
        function renderTestForm() {
            const formEl = document.getElementById('testParamsForm');

            if (appState.parameters.length === 0) {
                formEl.innerHTML = '<p style="color: var(--text-secondary);">æš‚æ— å‚æ•°</p>';
                return;
            }

            formEl.innerHTML = appState.parameters.map(param => `
                <div class="form-group">
                    <label class="form-label ${param.required ? 'required' : ''}">${param.name}</label>
                    <input type="text" name="${param.id}" class="form-input"
                        placeholder="${param.defaultValue || `è¾“å…¥${param.name}`}"
                        value="${param.defaultValue}">
                </div>
            `).join('');
        }

        // ========================================
        // é¡µé¢åˆå§‹åŒ–
        // ========================================

        document.addEventListener('DOMContentLoaded', function() {
            renderParametersTable();
        });

        // å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveReport();
            }
        });
    </script>
</body>
</html>
