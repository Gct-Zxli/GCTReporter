# Must Have 用户故事详细清单

> **📌 文档说明**：根据MoSCoW优先级分类，本文档包含程序员报表生成工具MVP中的10个Must Have（必须有）故事，这些故事构成系统的核心功能，缺一不可。
> **创建日期**: 2025-12-26
> **文档版本**: v1.0
> **优先级**: P0（最高优先级）

---

## 📊 Must Have故事概览

| 优先级 | 故事ID | 故事标题 | 用户角色 | 功能分组 | 端口 | 粒度 | 工作量 | 实现顺序 |
|--------|--------|---------|---------|---------|------|------|--------|---------|
| 0 | TS-000 | 搭建开发环境与项目初始化 | Dev Team | 基础设施 | 全端 | M | 1人日 | 0 |
| 1 | TS-001 | 数据库表结构设计 | Dev Team | 基础设施 | 后端 | M | 2人日 | 1 |
| 2 | US-014 | 用户登录与认证 | All | 认证框架 | 全端 | M | 2人日 | 2 |
| 3 | US-001 | SQL编写与参数定义 | Designer | SQL查询管理 | 设计端 | M | 1.5人日 | 3 |
| 4 | US-002 | 查询安全校验 | Designer | SQL查询管理 | 设计端 | M | 1.5人日 | 4 |
| 5 | US-003 | 查询执行与结果预览 | Designer | SQL查询管理 | 设计端 | M | 1.5人日 | 5 |
| 6 | US-004 | 列属性自定义配置 | Designer | 报表模板设计 | 设计端 | M | 1.5人日 | 6 |
| 7 | US-005 | 数据格式化设置 | Designer | 报表模板设计 | 设计端 | M | 1.5人日 | 7 |
| 8 | US-008 | 查看授权报表列表 | Viewer | 报表查询 | 用户端 | M | 1.5人日 | 8 |
| 9 | US-009 | 参数输入与查询执行 | Viewer | 报表查询 | 用户端 | M | 1.5人日 | 9 |
| 10 | US-013 | 报表与角色权限分配 | Admin | 权限管理 | 管理端 | M | 1.5人日 | 10 |

**关键指标**:
- **故事总数**: 11个（包含1个环境搭建故事）
- **预期工作量**: 16人日（含环境搭建1人日）
- **预期交付时间**: 8-9个工作日（2人并行开发）
- **占比**: 55% 的原始故事库（11/20）

---

## 🎯 详细故事列表

---

## 第0层：开发环境搭建（TS-000）

### TS-000: 搭建开发环境与项目初始化

**优先级**: 🔴 P0 - 最高（前置条件，必须首先完成）

**用户故事**

> 作为 **开发团队**，
> 我需要 **搭建完整的开发环境并初始化项目**，
> 以便 **所有团队成员能够在统一的开发环境中进行协作开发**。

**故事背景**

开发环境搭建是整个项目的基础。没有合理的开发环境、版本控制、项目结构和构建工具，整个团队的开发效率会大大降低。本故事涵盖后端环境、前端环境、版本控制、CI/CD初始化等。

**功能要点**

1. **后端开发环境**
   - JDK 11+ 安装和配置
   - Maven 3.6+ 或 Gradle 7.0+ 安装
   - Spring Boot 2.7.x 项目创建
   - MySQL 5.7+ 本地实例部署
   - IDE 配置（IntelliJ IDEA 或 Eclipse）
   - 项目依赖库下载（Spring Security、MyBatis、Lombok 等）

2. **前端开发环境**
   - Node.js 16+ 和 npm 8+ 安装
   - Vue 3 项目创建（Vite 或 @vue/cli）
   - 项目依赖安装（Element Plus、Axios、TypeScript 等）
   - IDE 配置（VS Code、WebStorm）
   - 代码格式化工具（Prettier、ESLint）

3. **版本控制与协作工具**
   - Git 初始化和远程仓库配置
   - .gitignore 配置（排除target、node_modules等）
   - Git 工作流规范定义（main、dev分支）
   - GitHub/GitLab/Gitee 访问权限设置

4. **本地开发工具**
   - Postman 或 Insomnia 安装（API测试）
   - MySQL Workbench 或 DataGrip 安装（数据库管理）
   - Docker 安装（可选，用于容器化）

5. **文档与规范**
   - README.md 编写（项目说明、快速开始）
   - 开发规范文档编写（代码风格、目录结构）
   - 环境配置说明（本地、测试、生产）

**技术设计细节**

**后端项目结构**:
```
programmer-report-backend/
├── src/
│   ├── main/
│   │   ├── java/com/example/report/
│   │   │   ├── controller/    # REST API控制层
│   │   │   ├── service/       # 业务逻辑层
│   │   │   ├── mapper/        # 数据访问层（MyBatis）
│   │   │   ├── entity/        # 实体类
│   │   │   ├── config/        # Spring配置类
│   │   │   └── utils/         # 工具类
│   │   └── resources/
│   │       ├── application.yml  # 配置文件
│   │       ├── application-dev.yml    # 开发环境配置
│   │       └── mapper/         # MyBatis映射文件
│   └── test/
│       └── java/               # 单元测试
├── pom.xml                    # Maven依赖配置
└── README.md

主要依赖:
- Spring Boot 2.7.x
- Spring Security
- MyBatis 3.5.x
- MySQL Connector 8.0.x
- Lombok
- JUnit 5
- Mockito
```

**前端项目结构**:
```
programmer-report-frontend/
├── src/
│   ├── components/        # 通用组件
│   ├── views/            # 页面组件
│   │   ├── Login.vue
│   │   ├── Designer/
│   │   ├── Viewer/
│   │   └── Admin/
│   ├── services/         # API服务层
│   ├── stores/          # Pinia 状态管理
│   ├── router/          # Vue Router 路由配置
│   ├── styles/          # CSS样式（全局）
│   ├── utils/           # 工具函数
│   ├── App.vue          # 根组件
│   └── main.ts          # 入口文件
├── public/              # 静态文件（logo、favicon等）
├── package.json         # npm依赖和脚本
├── vite.config.ts       # Vite构建配置
├── tsconfig.json        # TypeScript配置
└── README.md

主要依赖:
- Vue 3
- Element Plus 2.x
- Axios
- TypeScript
- Vite 4.x
- Pinia（状态管理）
- Vue Router 4.x
```

**Git工作流规范**:
```
主分支规范:
- main: 生产分支，标签对应release版本
- dev: 开发分支，集成所有特性

特性分支:
- feature/US-001: 特性开发分支
- bugfix/BUG-001: 缺陷修复分支
- release/v1.0: 发布分支

提交规范（Conventional Commits）:
- feat: 新特性
- fix: 缺陷修复
- docs: 文档更新
- style: 代码格式（不改逻辑）
- refactor: 代码重构
- test: 测试代码
- chore: 构建、依赖等

提交消息格式:
feat(auth): 实现用户登录功能
fix(sql): 修复SQL安全校验的XSS漏洞
```

**本地配置文件示例**:

后端配置（application-dev.yml）:
```yaml
server:
  port: 8080
  servlet:
    context-path: /api

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/programmer_report?useSSL=false&serverTimezone=UTC
    username: root
    password: root
    driver-class-name: com.mysql.cj.jdbc.Driver
  
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
  
  mvc:
    cors:
      allowed-origins: http://localhost:5173  # Vue开发服务器地址
      allowed-methods: GET,POST,PUT,DELETE

logging:
  level:
    root: INFO
    com.example.report: DEBUG
```

前端配置（.env.development）:
```
VITE_API_BASE_URL=http://localhost:8080/api
VITE_TIMEOUT=5000
```

**业务规则**

- 后端和前端使用独立的Git仓库
- 每个开发人员本地拥有完整的开发环境副本
- 数据库使用本地MySQL实例，支持快速初始化和重置
- 开发代码遵循统一的代码风格和目录结构
- 所有依赖通过Maven/npm进行管理，禁止手动添加jar/js文件

**验收标准**

- ✅ 后端项目能正常编译和运行（mvn clean compile）
- ✅ 前端项目能正常启动（npm run dev），页面加载正确
- ✅ 数据库本地实例正常连接，test表创建成功
- ✅ 所有IDE插件正确配置（格式化、代码检查等）
- ✅ Git仓库初始化完成，所有开发者可以clone和push
- ✅ README.md清晰明确，新开发者能按照说明快速搭建环境
- ✅ 前后端通信正常（后端接受前端请求，返回正确响应）
- ✅ 代码规范文档完善，包括命名、注释、目录结构等

**依赖关系**

- 无前置依赖
- 所有其他故事都依赖本故事

**技术约束**

- JDK 版本：11+（推荐17或21）
- MySQL 版本：5.7+（推荐8.0）
- Node.js 版本：16+（推荐18或20）
- Git 版本：2.25+
- 开发操作系统：Windows、macOS 或 Linux
- 互联网连接正常（下载依赖）

**工作量评估**: **1人日**
- 后端环境搭建和项目创建：0.3人日
- 前端环境搭建和项目创建：0.3人日
- Git配置、文档编写、验证测试：0.4人日

**实现建议**

1. **第一阶段**：后端环境搭建
   - 安装JDK、Maven
   - 创建Spring Boot项目框架
   - 配置MySQL连接
   - 编写一个Hello World接口用于验证

2. **第二阶段**：前端环境搭建
   - 安装Node.js、npm
   - 创建Vue 3项目
   - 集成Element Plus、Axios
   - 创建登录页面框架

3. **第三阶段**：版本控制和文档
   - 初始化Git仓库
   - 编写README.md和开发规范
   - 各成员clone仓库，验证环境
   - 互相Review环境配置

4. **第四阶段**：本地调试验证
   - 后端启动，访问Hello World接口
   - 前端启动，访问首页
   - 前后端通信测试（后端返回mock数据）
   - 确保所有开发者环境一致

---

## 第1层：基础设施（TS-001）

### TS-001: 数据库表结构设计

**优先级**: 🔴 P0 - 最高（前置条件）

**用户故事**

> 作为 **开发团队**，
> 我需要 **设计和创建系统所需的数据库表结构**，
> 以便 **为所有功能模块提供数据持久化基础**。

**故事背景**

数据库设计是所有功能的基础，没有合理的数据模型，后续的功能开发无法展开。本故事涵盖用户管理、报表配置、权限管理等所有核心数据表的设计和创建。

**功能要点**

1. **用户和角色表**
   - user 表：用户账户信息
   - role 表：系统角色定义
   - user_role 表：用户与角色的多对多关联

2. **报表配置表**
   - report 表：报表的基本信息（名称、描述、SQL等）
   - report_param 表：报表查询参数定义
   - report_column 表：报表列的展现配置

3. **权限管理表**
   - report_role 表：报表与角色的权限关联

4. **审计日志表**
   - audit_log 表：记录系统操作日志（用户登录、权限变更等）

**数据库设计细节**

```sql
-- 用户表
CREATE TABLE user (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  username VARCHAR(50) NOT NULL UNIQUE,
  password VARCHAR(255) NOT NULL,
  email VARCHAR(100),
  status INT DEFAULT 1,  -- 1:启用, 0:禁用
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_username(username)
);

-- 角色表
CREATE TABLE role (
  id INT PRIMARY KEY AUTO_INCREMENT,
  role_name VARCHAR(50) NOT NULL UNIQUE,
  description VARCHAR(255),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 用户角色关联表
CREATE TABLE user_role (
  user_id BIGINT NOT NULL,
  role_id INT NOT NULL,
  PRIMARY KEY (user_id, role_id),
  FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE,
  FOREIGN KEY (role_id) REFERENCES role(id) ON DELETE CASCADE
);

-- 报表表
CREATE TABLE report (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  sql_content LONGTEXT NOT NULL,
  creator_id BIGINT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (creator_id) REFERENCES user(id),
  INDEX idx_creator_id(creator_id)
);

-- 报表参数表
CREATE TABLE report_param (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  report_id BIGINT NOT NULL,
  param_name VARCHAR(50) NOT NULL,
  param_type VARCHAR(20),  -- String, Integer, Date, Decimal, Boolean
  default_value VARCHAR(255),
  is_required BOOLEAN DEFAULT FALSE,
  FOREIGN KEY (report_id) REFERENCES report(id) ON DELETE CASCADE,
  UNIQUE KEY unique_param(report_id, param_name)
);

-- 报表列配置表
CREATE TABLE report_column (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  report_id BIGINT NOT NULL,
  field_name VARCHAR(100) NOT NULL,
  display_name VARCHAR(100),
  column_width INT DEFAULT 100,  -- 像素
  format_type VARCHAR(20),  -- date, number, currency, percent
  sort_order INT DEFAULT 0,
  is_visible BOOLEAN DEFAULT TRUE,
  FOREIGN KEY (report_id) REFERENCES report(id) ON DELETE CASCADE,
  UNIQUE KEY unique_column(report_id, field_name)
);

-- 报表角色权限表
CREATE TABLE report_role (
  report_id BIGINT NOT NULL,
  role_id INT NOT NULL,
  PRIMARY KEY (report_id, role_id),
  FOREIGN KEY (report_id) REFERENCES report(id) ON DELETE CASCADE,
  FOREIGN KEY (role_id) REFERENCES role(id) ON DELETE CASCADE
);

-- 操作日志表
CREATE TABLE audit_log (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT,
  operation VARCHAR(50),  -- login, logout, create_report, update_permission
  resource_type VARCHAR(50),  -- user, report, role
  resource_id VARCHAR(100),
  details LONGTEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES user(id),
  INDEX idx_created_at(created_at),
  INDEX idx_user_id(user_id)
);

-- 初始化角色
INSERT INTO role (role_name, description) VALUES
  ('ADMIN', '系统管理员，拥有所有权限'),
  ('DESIGNER', '报表设计者，可以创建和设计报表'),
  ('VIEWER', '普通用户，只能查看授权的报表');
```

**技术设计要点**

1. **表设计原则**
   - 使用InnoDB引擎，支持事务和外键约束
   - 所有主键使用自增ID
   - 关键字段创建索引，提高查询性能
   - 时间戳字段记录创建和修改时间

2. **索引策略**
   - username: 用于快速查找用户
   - creator_id: 用于查找用户创建的报表
   - created_at: 用于时间范围查询
   - 外键自动创建索引

3. **数据完整性**
   - 使用外键约束确保数据一致性
   - DELETE CASCADE: 删除用户时自动删除相关记录
   - UNIQUE 约束防止重复数据

4. **扩展性**
   - report_column 表设计为灵活的配置表，支持任意列数
   - format_type 支持扩展（日期、数字、货币、百分比等）
   - audit_log 支持记录任意类型的操作

**业务规则**

- 系统预定义三个角色：ADMIN、DESIGNER、VIEWER（在脚本中初始化）
- 所有表使用InnoDB引擎，确保事务支持
- 外键约束确保数据完整性
- 时间戳字段自动记录，便于审计

**验收标准**

- ✅ 所有8个核心表创建成功
- ✅ 字段类型和长度合理、符合业务需求
- ✅ 所有索引创建完毕（6个+）
- ✅ 外键约束配置正确
- ✅ 初始化脚本包含3个角色数据
- ✅ 脚本可在不同环境重复执行，具有幂等性
- ✅ 数据库连接正常，所有表能正确查询

**依赖关系**

- 无前置依赖
- 所有其他故事都依赖本故事

**技术约束**

- 数据库版本：MySQL 5.7+
- 字符集：UTF8MB4（支持中文和emoji）
- 排序规则：utf8mb4_unicode_ci
- 时区：UTC（避免时区问题）

**工作量评估**: **2人日**
- 数据库设计和表结构定义：1人日
- SQL脚本编写、测试、文档：1人日

**实现建议**

1. **第一阶段**：完成数据库设计和SQL脚本编写
2. **第二阶段**：在开发、测试、生产环境执行脚本，验证成功
3. **第三阶段**：编写数据库操作文档，供后续的ORM框架集成使用

---

## 第2层：认证框架（US-014）

### US-014: 用户登录与认证

**优先级**: 🔴 P0 - 最高（所有端的前置条件）

**用户故事**

> 作为 **任何用户（Admin/Designer/Viewer）**，
> 我希望 **能够使用用户名和密码登录系统**，
> 以便 **访问自己有权限的功能和数据**。

**故事背景**

认证是系统的安全基础，所有用户在访问任何功能之前都必须完成身份验证。本故事实现一个完整的登录流程，包括身份验证、会话管理和权限初始化。

**功能要点**

1. **登录页面**
   - 用户名输入框（不区分大小写）
   - 密码输入框
   - 登录按钮
   - 重置按钮
   - 品牌logo和应用名称
   - 清晰的错误提示

2. **认证机制**
   - 从数据库查询用户账户
   - 验证密码正确性（使用加密算法）
   - 记录登录日志
   - 创建用户会话

3. **会话管理**
   - Session 或 Token 方式
   - 30分钟无操作自动登出
   - 用户重新登录时清除旧会话
   - 登出时完全清除会话信息

4. **登出功能**
   - 页面导航栏中的登出按钮
   - 清除服务端会话
   - 清除前端缓存
   - 重定向回登录页面

**业务规则**

1. **账户安全规则**
   - 用户名唯一，不区分大小写
   - 密码最少8字符，需要包含字母和数字
   - 密码使用BCrypt或MD5加盐加密存储（不能明文）
   - 登录时使用加密密码对比，不解密

2. **登录防护规则**
   - 登录失败5次在5分钟内禁止再次尝试
   - 显示清晰的错误提示（账号不存在、密码错误、账户被禁用）
   - 不区分"账号不存在"和"密码错误"的提示（安全考虑）

3. **会话管理规则**
   - Session 超时时间：30分钟无操作
   - Token 过期时间：2小时（可延期）
   - 支持多终端登录（不同设备同时登录同一用户）
   - 权限变更后需要重新登录生效

4. **审计规则**
   - 记录所有登录操作（成功和失败）
   - 记录登出操作
   - 记录异常登录（如 IP 异常、大量失败）

**界面设计**

**登录页面布局**:
```
┌─────────────────────────────────────┐
│        报表生成工具 Logo             │
│     程序员报表生成工具 v1.0          │
├─────────────────────────────────────┤
│                                      │
│  用户名: [________________]         │
│  密码:   [________________]         │
│                                      │
│  [  登录  ]  [  重置  ]             │
│                                      │
│  ❌ 账户名称或密码错误                  │
│                                      │
└─────────────────────────────────────┘
```

**验证流程图**:
```
输入用户名 → 输入密码 → 点击登录
     ↓
数据库查询用户
     ↓ (找到) → 验证密码
        (未找到) → 显示错误，次数+1
     ↓ (正确) → 创建Session → 跳转首页
        (错误) → 显示错误，次数+1
     ↓ (次数≥5) → 禁止登录5分钟
```

**技术实现细节**

1. **后端认证流程**
   ```java
   @PostMapping("/login")
   public ResponseEntity login(@RequestBody LoginRequest request) {
       // 1. 校验参数
       validateLoginParams(request);
       
       // 2. 查询用户
       User user = userService.findByUsername(request.getUsername());
       if (user == null) {
           recordFailedLogin(request.getUsername());
           return error("用户名或密码错误");
       }
       
       // 3. 验证密码
       if (!passwordEncoder.matches(request.getPassword(), user.getPassword())) {
           recordFailedLogin(request.getUsername());
           return error("用户名或密码错误");
       }
       
       // 4. 检查账户状态
       if (user.getStatus() == 0) {
           return error("账户已被禁用");
       }
       
       // 5. 创建Session
       HttpSession session = request.getSession(true);
       session.setAttribute("user", user);
       session.setAttribute("roles", user.getRoles());
       
       // 6. 记录登录日志
       auditService.log(user.getId(), "login", "user", user.getId());
       
       // 7. 返回成功
       return success("登录成功");
   }
   ```

2. **前端登录流程**
   - 使用 Vue 或 React 的表单组件
   - 密码通过 HTTPS 传输
   - 登录成功后存储 Session Cookie 或 Token
   - 导航到首页或权限对应的页面

3. **会话维护**
   - 每个请求自动更新 Session 过期时间
   - 30分钟无操作自动登出
   - 使用 Spring Session 或类似框架简化会话管理

**验收标准**

- ✅ 登录页面能正确加载
- ✅ 输入正确的用户名和密码可以登录成功
- ✅ 输入错误的用户名或密码显示错误提示
- ✅ 登录成功后跳转到首页（根据权限显示对应端口）
- ✅ 登出按钮清除会话，用户必须重新登录
- ✅ 密码加密存储，不能明文显示
- ✅ Session 超时时间设置为30分钟
- ✅ 登录失败5次禁止再次尝试5分钟
- ✅ 登录和登出操作记录到审计日志
- ✅ 禁用的账户无法登录
- ✅ HTTPS 环境下密码安全传输

**依赖关系**

- 前置依赖: TS-001 (数据库设计)
- 被依赖: 所有其他故事都需要完成登录才能使用

**技术约束**

- 密码加密使用 BCrypt (推荐) 或 MD5+盐
- 会话使用 HttpSession 或 JWT Token
- 登录日志记录到 audit_log 表
- HTTPS 传输（生产环境必须）
- Session 存储可使用 Redis（分布式部署时）

**工作量评估**: **2人日**
- 后端：认证服务、Session 管理、密码加密、登录日志（1.5人日）
- 前端：登录页面、登出按钮、权限导航（0.5人日）

**实现建议**

1. 使用 Spring Security 框架简化认证逻辑
2. 密码加密使用 BCrypt（自动加盐）
3. 使用 Spring Session 简化会话管理
4. 前后端分离，后端提供 REST API
5. 使用拦截器检查登录状态，未登录返回 401

---

## 第3-7层：设计端核心功能（US-001/002/003/004/005）

### US-001: SQL编写与参数定义

**优先级**: 🔴 P0

**用户故事**

> 作为 **报表设计者（Designer）**，
> 我希望 **能够输入SQL查询语句并定义查询参数**，
> 以便 **支持参数化查询，满足不同场景的数据查询需求**。

**故事背景**

SQL 编写是报表设计的基础。设计者需要灵活地输入 SQL 查询语句，并定义参数以支持不同条件的查询。例如，一个"订单报表"可能需要参数化"订单日期"、"销售员"等，以便生成不同日期范围的订单。

**功能要点**

1. **SQL 编辑器**
   - 代码高亮（SELECT、WHERE、FROM 等关键字）
   - 自动缩进和格式化
   - 代码折叠功能
   - 行号显示

2. **SQL 参数定义**
   - 参数名称（使用 `#{paramName}` 格式）
   - 参数类型选择（String、Integer、Date、Decimal、Boolean）
   - 参数默认值设置
   - 必填/可选标记

3. **SQL 模板保存**
   - 为 SQL 和参数配置命名
   - 支持修改已保存的模板
   - 支持删除模板

**业务规则**

- 仅允许 SELECT 语句（非 SELECT 语句在安全校验阶段会被拒绝）
- 参数占位符必须使用 `#{paramName}` 格式
- 参数名称必须唯一且遵循命名规范（字母、数字、下划线）
- 最多支持 100 个查询参数
- 参数类型映射：
  - String → 文本参数
  - Integer → 整数参数
  - Date → 日期参数
  - Decimal → 小数参数
  - Boolean → 是/否选择

**界面设计**

**报表编辑页面**:
```
┌────────────────────────────────────────────────────┐
│ 编辑报表: 销售订单报表                              │
├────────────────────────────────────────────────────┤
│ [保存]  [测试]  [预览]  [删除]                    │
├────────────────────────────────────────────────────┤
│ SQL 语句:                                          │
│ ┌──────────────────────────────────────────────┐  │
│ │ SELECT order_id, customer_name, amount       │  │
│ │ FROM orders                                  │  │
│ │ WHERE order_date >= #{startDate}            │  │
│ │   AND order_date <= #{endDate}              │  │
│ │   AND salesman = #{salesman}                │  │
│ └──────────────────────────────────────────────┘  │
├────────────────────────────────────────────────────┤
│ 查询参数:                                          │
│ ┌─────────────────────────────────────────────┐  │
│ │ 参数名    │ 类型    │ 默认值 │ 必填 │      │  │
│ ├──────────┼────────┼───────┼──────┤      │  │
│ │startDate │ Date   │       │  ✓   │  ×   │  │
│ │endDate   │ Date   │       │  ✓   │  ×   │  │
│ │salesman  │ String │       │      │  ×   │  │
│ └─────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────┘
```

**验收标准**

- ✅ 支持输入 SQL SELECT 语句
- ✅ 参数定义表单功能完整（新增、编辑、删除）
- ✅ 支持 5 种参数类型
- ✅ 参数默认值可配置
- ✅ SQL 模板保存成功，刷新后能重新加载
- ✅ 参数占位符 `#{paramName}` 能正确识别

**依赖关系**

- 前置依赖: US-014 (用户登录)
- 被依赖: US-002 (安全校验)

**工作量评估**: **1.5人日**
- 后端：SQL 参数解析、模板存储（1人日）
- 前端：编辑器集成、参数表单（0.5人日）

---

### US-002: 查询安全校验

**优先级**: 🔴 P0 - 最高（安全关键）

**用户故事**

> 作为 **报表设计者（Designer）**，
> 我希望 **系统能够自动检查SQL语句中的安全风险**，
> 以便 **防止恶意SQL注入攻击，保护数据库安全**。

**故事背景**

SQL 注入是最常见的数据库安全漏洞。本故事实现自动的 SQL 安全校验，在执行查询前检查是否包含危险操作（如 DROP、DELETE 等），保护系统安全。

**功能要点**

1. **黑名单关键字检查**
   - 危险 DML: INSERT、UPDATE、DELETE、DROP、TRUNCATE
   - 危险 DDL: ALTER、CREATE、TRUNCATE
   - 系统命令: EXEC、EXECUTE
   - 脚本语言: SCRIPT、JAVASCRIPT

2. **安全规则检查**
   - 仅允许 SELECT 语句
   - SQL 长度限制（最多 10000 字符）
   - 注释符号检查（防止注释绕过）

3. **实时反馈**
   - 实时校验结果显示
   - 安全警告提示
   - 禁用不安全的执行按钮

**业务规则**

- 严禁包含任何 DML 语句（会导致数据修改）
- 严禁包含 DDL 语句（会导致表结构改变）
- 严禁包含系统命令（可能导致权限提升）
- 参数占位符必须使用 PreparedStatement 方式绑定（后端实现）
- 查询超时限制为 5 秒（后端实现）

**界面设计**

**安全校验提示**:
```
SQL 编辑器下方显示校验结果:

✅ 安全通过 - 此 SQL 语句可以安全执行
   建议: 确保所有参数都已在上方定义

❌ 检测到危险关键字: DROP
   问题: 您的SQL包含DROP语句，这可能导致表被删除
   建议: 仅使用SELECT语句进行数据查询

⚠️  SQL 长度过长: 15000 字符（限制: 10000 字符）
   建议: 简化SQL或分解为多个查询
```

**验收标准**

- ✅ 成功检测 DROP、DELETE 等危险关键字
- ✅ 检测到危险操作时禁止执行
- ✅ 清晰的错误提示信息，告诉用户具体问题
- ✅ 校验性能良好（<200ms）
- ✅ 支持通过安全校验的 SELECT 语句继续执行
- ✅ 覆盖常见 SQL 注入攻击的测试用例

**依赖关系**

- 前置依赖: US-001 (SQL 编写)
- 被依赖: US-003 (查询执行)

**工作量评估**: **1.5人日**
- 后端：SQL 安全校验模块、关键字黑名单（1人日）
- 前端：校验结果展示、交互反馈（0.5人日）

---

### US-003: 查询执行与结果预览

**优先级**: 🔴 P0

**用户故事**

> 作为 **报表设计者（Designer）**，
> 我希望 **能够执行SQL查询并预览结果**，
> 以便 **快速验证SQL和参数配置的正确性，支持设计阶段的调试**。

**故事背景**

设计者需要在设计阶段多次测试 SQL 和参数配置，确保查询逻辑正确。本故事提供查询执行和结果预览功能，支持设计者的迭代调试。

**功能要点**

1. **查询执行**
   - 调用后端 API 执行 SQL
   - 参数绑定和值替换
   - 超时控制和异常处理

2. **结果展示**
   - 动态表格展示查询结果
   - 列元数据显示（字段名、数据类型）
   - 分页展示（每页 100 条）
   - 查询性能指标（耗时、行数）

3. **调试支持**
   - 支持多次执行
   - 实时参数修改和重新查询
   - 清晰的错误提示

**界面设计**

**预览结果页面**:
```
┌──────────────────────────────────────────────┐
│ 查询结果预览                                  │
├──────────────────────────────────────────────┤
│ 执行耗时: 0.5秒  |  返回行数: 1,234行       │
├──────────────────────────────────────────────┤
│ ┌────────────────────────────────────────┐  │
│ │ order_id │ customer_name  │ amount     │  │
│ ├──────────┼────────────────┼────────────┤  │
│ │ 10001    │ 张三           │ ¥1,234.50  │  │
│ │ 10002    │ 李四           │ ¥2,345.00  │  │
│ │ 10003    │ 王五           │ ¥3,456.78  │  │
│ │ ...      │ ...            │ ...        │  │
│ └────────────────────────────────────────┘  │
├──────────────────────────────────────────────┤
│ [首页] [上一页] 第 1 页，共 13 页 [下一页] [末页]  │
└──────────────────────────────────────────────┘
```

**验收标准**

- ✅ SQL 执行成功并返回数据
- ✅ 结果表格显示所有列和行
- ✅ 分页正确，总行数准确
- ✅ 查询耗时显示准确
- ✅ 超过 5 秒自动超时中止（防止大查询）
- ✅ 超过 10000 行提示警告（防止前端卡顿）
- ✅ 执行失败显示错误原因（SQL 错误、权限问题等）

**依赖关系**

- 前置依赖: US-002 (安全校验)
- 被依赖: US-004 (列属性配置)

**工作量评估**: **1.5人日**
- 后端：查询执行引擎、超时控制、数据转换（1人日）
- 前端：结果表格显示、分页（0.5人日）

---

### US-004: 列属性自定义配置

**优先级**: 🔴 P0

**用户故事**

> 作为 **报表设计者（Designer）**，
> 我希望 **能够对查询结果的列进行自定义配置**，
> 以便 **优化报表展现效果，提升用户体验**。

**故事背景**

SQL 查询返回的列可能不适合直接展示。设计者需要自定义列的显示名称、宽度、顺序等，使报表更加专业和易读。

**功能要点**

1. **列配置**
   - 显示名称自定义（中文名称）
   - 列宽设置（拖拽或输入）
   - 列顺序调整（拖拽）
   - 显示/隐藏切换

2. **配置持久化**
   - 列配置保存到数据库
   - 重新加载报表时恢复配置

**业务规则**

- 至少显示一列（不能全部隐藏）
- 列宽范围：50-500px
- 显示名称最多 50 个字符
- 列配置以 JSON 格式存储

**验收标准**

- ✅ 自定义显示名称保存成功
- ✅ 列宽在范围内可设置
- ✅ 列顺序拖拽有效
- ✅ 隐藏列后预览不显示
- ✅ 配置持久化到数据库
- ✅ 重新加载报表保留配置

**依赖关系**

- 前置依赖: US-003 (查询执行)
- 被依赖: US-005 (数据格式化)

**工作量评估**: **1.5人日**

---

### US-005: 数据格式化设置

**优先级**: 🔴 P0

**用户故事**

> 作为 **报表设计者（Designer）**，
> 我希望 **能够对不同数据类型的列进行格式化**，
> 以便 **提高报表数据的可读性和专业度**。

**故事背景**

原始数据的格式可能不够友好。例如，日期显示为 "2025-12-26"，货币显示为 "1234.5"。设计者需要设置合适的格式，使数据更容易理解。

**功能要点**

1. **日期格式化**
   - 支持多种格式：yyyy-MM-dd、yyyy/MM/dd、dd-MM-yyyy
   - 自定义格式支持

2. **数字格式化**
   - 千位符（1,234.50）
   - 小数位数（1-4 位）
   - 整数显示

3. **货币格式化**
   - 货币符号（$、¥、€）
   - 小数位数

4. **百分比格式化**

**业务规则**

- 格式化仅影响显示，不改变原始数据
- 格式化错误时降级显示原始值
- Excel 导出时保留格式化效果

**验收标准**

- ✅ 日期格式化显示正确
- ✅ 数字千位符显示正确
- ✅ 小数位数控制准确
- ✅ 货币符号显示正确
- ✅ 格式化预览结果准确
- ✅ Excel 导出保留格式化

**依赖关系**

- 前置依赖: US-004 (列属性配置)
- 被依赖: US-006 (报表预览) - 可选

**工作量评估**: **1.5人日**

---

## 第8-9层：用户端核心功能（US-008/009）

### US-008: 查看授权报表列表

**优先级**: 🔴 P0

**用户故事**

> 作为 **普通用户（Viewer）**，
> 我希望 **能够查看自己有权限访问的报表列表**，
> 以便 **快速找到需要的报表进行查询**。

**故事背景**

用户端的入口是报表列表。用户需要快速找到已授权的报表，然后进入查询页面。系统需要根据用户的角色和权限进行过滤。

**功能要点**

1. **报表列表显示**
   - 报表名称、描述、创建人、创建时间
   - 按名称搜索
   - 按时间排序
   - 分页显示（每页 20 个）

2. **权限过滤**
   - 仅显示当前用户有权限的报表
   - ADMIN 显示所有报表
   - DESIGNER 显示已授权 + 自己创建的报表
   - VIEWER 显示已授权的报表

**验收标准**

- ✅ 仅显示有权报表
- ✅ 列表信息完整
- ✅ 搜索功能正常
- ✅ 排序功能正常
- ✅ 分页功能正常
- ✅ 点击进入查询页面

**依赖关系**

- 前置依赖: US-014 (用户登录)
- 被依赖: US-009 (参数输入与查询)

**工作量评估**: **1.5人日**

---

### US-009: 参数输入与查询执行

**优先级**: 🔴 P0

**用户故事**

> 作为 **普通用户（Viewer）**，
> 我希望 **能够输入查询参数并执行报表查询**，
> 以便 **获取符合条件的数据结果**。

**故事背景**

用户选择报表后进入查询页面。根据设计者定义的参数，系统自动生成参数输入表单。用户填入参数值并执行查询，获得结果。

**功能要点**

1. **参数表单自动生成**
   - 根据参数定义生成对应的输入控件
   - 参数校验（必填、格式）
   - 参数默认值填充

2. **查询执行**
   - 后端执行 SQL 查询
   - 结果返回和显示

**业务规则**

- 必填参数必须填写后才能执行
- 参数值格式必须匹配定义的类型
- 查询超时 5 秒
- 结果最多显示 10000 行

**验收标准**

- ✅ 参数表单动态生成
- ✅ 参数校验有效
- ✅ 必填参数检查正常
- ✅ 查询执行成功
- ✅ 结果显示完整
- ✅ 参数默认值正确

**依赖关系**

- 前置依赖: US-008 (报表列表)
- 被依赖: US-010 (分页排序)

**工作量评估**: **1.5人日**

---

## 第10层：权限管理（US-013）

### US-013: 报表与角色权限分配

**优先级**: 🔴 P0 - 最高（支持权限隔离）

**用户故事**

> 作为 **系统管理员（Admin）**，
> 我希望 **能够配置报表对应的可访问角色**，
> 以便 **在设计端配置的基础上进行全局权限管理**。

**故事背景**

权限管理是系统的安全保证。管理员需要为每个报表分配可访问的角色，确保普通用户只能看到授权的报表。

**功能要点**

1. **权限配置**
   - 选择报表
   - 选择可访问的角色
   - 支持多角色授权
   - 取消角色授权

2. **权限管理**
   - 查看现有权限分配
   - 权限变更立即生效

**业务规则**

- ADMIN 角色自动拥有所有报表权限（无需配置）
- 一个报表可分配给多个角色
- 报表创建者（Designer）自动拥有访问权限
- 权限变更立即生效

**验收标准**

- ✅ 权限配置保存正确
- ✅ 多角色授权有效
- ✅ 权限变更立即生效
- ✅ 权限冲突检查准确
- ✅ 审计日志记录完整

**依赖关系**

- 前置依赖: US-014 (用户登录)、TS-001 (数据库设计)
- 被依赖: 权限隔离的基础

**工作量评估**: **1.5人日**

---

## 📅 实现排期规划

### Sprint 1 详细日程（5 个工作日）

| 日期 | 任务 | 负责人 | 工作量 |
|------|------|--------|--------|
| Day 1 | TS-001: 数据库设计 + 脚本 | 后端 | 2人日 |
| Day 2 | US-014: 登录认证（后端） | 后端 | 1人日 |
| Day 2 | US-014: 登录认证（前端） | 前端 | 0.5人日 |
| Day 3 | US-001: SQL 编写（后端） | 后端 | 0.5人日 |
| Day 3 | US-001: SQL 编写（前端） | 前端 | 0.5人日 |
| Day 3 | US-002: 安全校验（后端） | 后端 | 0.5人日 |
| Day 3 | US-002: 安全校验（前端） | 前端 | 0.5人日 |
| Day 4 | US-003: 查询执行（后端） | 后端 | 0.5人日 |
| Day 4 | US-003: 查询执行（前端） | 前端 | 0.5人日 |
| Day 4 | US-004: 列属性配置（后端） | 后端 | 0.5人日 |
| Day 4 | US-004: 列属性配置（前端） | 前端 | 0.5人日 |
| Day 5 | US-005: 格式化设置（后端） | 后端 | 0.5人日 |
| Day 5 | US-005: 格式化设置（前端） | 前端 | 0.5人日 |
| Day 5 | US-008: 报表列表（后端） | 后端 | 0.5人日 |
| Day 5 | US-008: 报表列表（前端） | 前端 | 0.5人日 |
| Day 5 | US-009: 查询执行（后端） | 后端 | 0.5人日 |
| Day 5 | US-009: 查询执行（前端） | 前端 | 0.5人日 |
| Day 5 | US-013: 权限分配（后端） | 后端 | 0.5人日 |
| Day 5 | US-013: 权限分配（前端） | 前端 | 0.5人日 |
| Day 1-5 | TS-003: API 文档 | 全端 | 1人日 |

**合计**: 15人日核心工作 + 1人日文档 = 16人日 / 2人 = 8个工作日

实际上通过前后端并行开发，可控制在 5 个工作日内完成。

---

## ✅ Must Have 故事完成条件

### 定义：什么是"Must Have 故事完成"

1. ✅ **代码实现完成**
   - 后端 API 实现
   - 前端 UI 实现
   - 数据库表创建

2. ✅ **单元测试通过**
   - 正常流程测试通过
   - 异常流程测试通过
   - 边界条件测试通过

3. ✅ **集成测试通过**
   - 前后端 API 对接成功
   - 数据流完整
   - 权限隔离正确

4. ✅ **验收标准全部通过**
   - 每个故事的验收标准都已验证

5. ✅ **代码审查通过**
   - 代码质量符合规范
   - 没有安全漏洞

### 定义：什么是"Sprint 1 完成"

所有 10 个 Must Have 故事都满足上述完成条件。

---

## 📊 工作量总结

| 故事ID | 故事标题 | 后端 | 前端 | 合计 |
|--------|---------|------|------|------|
| TS-000 | 搭建开发环境与项目初始化 | 0.3 | 0.3 | 1.0 |
| TS-001 | 数据库表结构设计 | 2.0 | - | 2.0 |
| US-014 | 用户登录与认证 | 1.5 | 0.5 | 2.0 |
| US-001 | SQL编写与参数定义 | 1.0 | 0.5 | 1.5 |
| US-002 | 查询安全校验 | 1.0 | 0.5 | 1.5 |
| US-003 | 查询执行与结果预览 | 1.0 | 0.5 | 1.5 |
| US-004 | 列属性自定义配置 | 1.0 | 0.5 | 1.5 |
| US-005 | 数据格式化设置 | 1.0 | 0.5 | 1.5 |
| US-008 | 查看授权报表列表 | 1.0 | 0.5 | 1.5 |
| US-009 | 参数输入与查询执行 | 1.0 | 0.5 | 1.5 |
| US-013 | 报表与角色权限分配 | 1.0 | 0.5 | 1.5 |
| **合计** | | **13.5人日** | **4.5人日** | **18人日** |

**调整说明**：
- 新增TS-000环境搭建：1人日
- 原TS-001改为2人日（从1人日调整）
- 总工作量从16人日增至18人日（含环境搭建）
- 后端工作量：13.5人日，前端工作量：4.5人日

---

## 🔗 相关文档

- [用户故事拆解-程序员报表生成工具MVP](./用户故事拆解-程序员报表生成工具MVP.md)
- [用户故事质量评估与优先级排序](./用户故事质量评估与优先级排序.md)
- [Epic分析-程序员报表生成工具](./doc/prompts/Epic分析-程序员报表生成工具.md)

---

**文档版本**: v1.0  
**最后更新**: 2025-12-26  
**作者**: AI敏捷管理  
**审核状态**: ⏳ 待产品经理和技术团队审核

**关键要点**:
- ✅ 10 个 Must Have 故事清晰明确
- ✅ 每个故事包含完整的业务规则和验收标准
- ✅ 估算的 16 人日工作量符合 2 周 MVP 计划
- ✅ 故事顺序清晰，依赖关系明确
- 🎯 Sprint 1 目标：完成所有 10 个 Must Have 故事，奠定 MVP 基础
