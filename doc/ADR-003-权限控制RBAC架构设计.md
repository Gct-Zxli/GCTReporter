# ADR-003：权限控制RBAC架构设计

| 属性 | 内容 |
|------|------|
| **ADR编号** | ADR-003 |
| **状态** | 已接受 |
| **决策日期** | 2025-12-26 |
| **决策人** | 架构团队 |
| **关联需求** | Epic §2.1 模块F RBAC，US-012~US-016 权限相关故事 |
| **替代ADR** | 无 |

---

## 背景

### 业务需求

实现基于角色的权限控制（RBAC），支持三个角色（Admin、Designer、Viewer），进行用户-角色关联和报表-角色关联，实现多级权限隔离。

**来源**：Epic §2.1 模块F 权限控制（RBAC）

### 技术约束

| 约束项 | 具体内容 | 来源 |
|--------|---------|------|
| **角色类型** | 固定三个：Admin、Designer、Viewer | Epic §2.1 模块F 权限矩阵 |
| **权限继承** | Admin > Designer > Viewer（权限梯队） | Epic §2.1 模块F 权限矩阵 |
| **关联方式** | 用户-角色多对多、报表-角色多对多 | Epic §2.1 模块F 权限矩阵 |
| **性能要求** | 权限查询<100ms（不能影响API性能） | Epic §2.1 模块F 技术难点 |
| **隔离方式** | 三端物理隔离 + API层权限校验 | ADR-001 架构决策 |

### 当前痛点

- 权限泄露是系统最大的安全风险
- 不同端的权限校验逻辑分散，容易产生漏洞
- 权限变更时难以及时同步到所有端

**来源**：Epic §3.1 风险3 多端权限同步

---

## 决策

### 核心方案选择

**采用后端权限集中模式**：
1. **后端单一真源**：权限检查只在后端进行，所有API请求都经过权限校验
2. **前端权限缓存**：登录时同步一次权限到前端，用于UI渲染（不用于权限判定）
3. **权限变更强制重新登录**：权限变更后用户需重新登录以获取最新权限
4. **权限审计日志**：记录所有权限相关操作，用于追踪和审计

**核心理由**：
后端集中管理权限是唯一可信的方式，避免前端权限缓存不同步导致的泄露。强制重新登录虽然影响用户体验，但2周MVP范围内可以接受（V2考虑Redis同步优化）。来源：Epic §3.2 多端权限同步风险 缓解方案。

---

## 候选方案

### 权限控制架构方案对比

| 维度 | 方案A：后端集中 | 方案B：前后端同步 | 方案C：前端自主 |
|------|---------------|-----------|---------  |
| **安全性** | 高（后端权威） | 中（同步延迟） | 低（易被绕过） |
| **复杂度** | 中（拦截器） | 高（消息队列） | 低（代码简单） |
| **用户体验** | 中（需重新登录） | 高（权限实时更新） | 优（无限制） |
| **性能开销** | 低（缓存查询） | 中（消息同步） | 低（无检查） |
| **实现工作量** | 中（2人日） | 高（4人日） | 低（0.5人日） |
| **后期维护** | 低（集中管理） | 中（两端维护） | 高（多处修改） |
| **安全风险** | 低 | 中 | 🔴 高 |

#### 详细方案说明

##### 方案A：后端权限集中（推荐）

**工作流程**：

```
用户登录
  ↓
后端验证用户名密码
  ↓
生成JWT Token + 权限清单
  ↓
返回Token + 权限清单到前端
  ↓
前端存储Token + 权限清单到SessionStorage
  ↓
前端用权限清单渲染UI（显示/隐藏菜单）
  ↓
用户发送API请求
  ↓
后端拦截器解析Token，获取userId
  ↓
后端查询该userId的权限（从数据库或Redis缓存）
  ↓
比较请求资源(reportId) 与 用户权限(allowedReports)
  ↓
IF 权限允许 THEN 执行请求 ELSE 返回403 Forbidden
```

**权限数据结构**：

```javascript
// 用户权限清单（缓存在前端，仅用于UI渲染）
{
  userId: 123,
  roles: ['DESIGNER'],  // 用户可能有多个角色
  allowedReports: [
    { reportId: 1, reportName: '销售报表' },
    { reportId: 2, reportName: '库存报表' }
  ],
  permissions: ['report.create', 'report.edit', 'report.preview']
}

// 后端权限校验表（数据库表）
user_role (多对多)
  - user_id
  - role_id
  - created_time

report_role (多对多)
  - report_id
  - role_id
  - created_time

// 权限矩阵（常数，不需要存数据库）
ROLE_PERMISSIONS = {
  ADMIN: ['report.*', 'user.*', 'role.*'],
  DESIGNER: ['report.create', 'report.edit', 'report.preview'],
  VIEWER: ['report.view', 'report.export']
}
```

**优点**：
- 权限校验唯一可信
- 简化逻辑，减少漏洞
- 便于审计（所有权限决策在后端有日志）

**缺点**：
- 权限变更后用户需重新登录
- 前端需要维护权限缓存的刷新逻辑

##### 方案B：前后端同步（Redis发布-订阅）

**工作流程**：

```
权限变更（管理员编辑用户角色）
  ↓
后端保存到数据库
  ↓
后端发布Redis事件："user:123:permission:changed"
  ↓
前端WebSocket监听权限变更事件
  ↓
前端接收到变更，自动刷新权限清单
  ↓
UI重新渲染（无需用户重新登录）
```

**优点**：
- 用户体验好（权限变更实时生效）
- 权限变更无需重新登录

**❌ 劣势**：
1. **实现复杂**：需要Redis、WebSocket、事件系统
2. **同步延迟**：网络延迟可能导致权限缓存不一致
3. **失败处理**：如果事件未送达，前端缓存过期，仍需重新登录
4. **工作量大**：4人日（远超MVP 2周时间约束）
5. **风险高**：同步机制复杂容易出现bug，导致权限泄露

**结论**：适合大型系统，不适合MVP阶段

##### 方案C：前端自主（无权限校验）

**❌ 严重问题**：
1. **无法防止权限绕过**：用户可以修改前端代码删除权限检查
2. **无法防止直接API访问**：使用curl/Postman绕过前端，直接调用后端API
3. **完全无效**：无法满足安全要求

**结论**：绝对不能采用，违反Epic §1.1"零P0级Bug"的安全目标

---

## 权衡分析

### 方案A：后端权限集中（推荐）

**✅ 优势**：

1. **安全性最高**：所有权限决策在后端，无法绕过
   - 即使前端权限缓存被篡改，后端仍会拒绝请求
   - 满足Epic §1.1"零P0级Bug"的安全目标
   - 来源：Epic §3.2 多端权限同步 缓解方案

2. **实现简单**：使用Spring Security拦截器即可
   - 标准的Spring框架能力
   - 工作量仅2人日
   - 代码复用性高（一套拦截器保护所有端）
   - 来源：Epic §1.2 技术复杂度评估

3. **易于审计**：所有权限决策都有后端日志
   - 便于安全审查和追溯
   - 符合合规要求（如SOX法案）
   - 来源：基于企业治理要求补充

4. **性能优化空间大**：权限查询可以缓存
   - 首次查询数据库，后续使用Redis缓存
   - 性能P95<100ms（满足约束）
   - 来源：Epic §2.1 模块F 性能要求

**❌ 劣势**：

1. **用户体验稍差**：权限变更后需要重新登录
   - 影响用户体验，但可接受
   - 缓解措施：权限变更时前端主动提示用户重新登录（0.5人日）
   - 来源：基于使用场景补充

2. **前端缓存一致性管理**：需要定期刷新权限缓存
   - 如果缓存过期，UI可能显示用户无权限的菜单
   - 缓解措施：设置缓存过期时间为2小时，超期自动刷新；前端拦截非授权API调用显示"权限已过期"提示
   - 来源：基于缓存管理经验补充

3. **Redis缓存管理成本**：需要额外维护Redis
   - 如果权限查询频繁，可能对Redis产生压力
   - 缓解措施：初期不用Redis（直接查询DB），等性能瓶颈出现再优化（优先级P2）
   - 来源：基于性能优化建议补充

### 方案B：前后端同步

**✅ 优势**：
1. 用户体验最好：权限变更实时生效，无需重新登录

**❌ 劣势**：
1. 同步机制复杂，容易出现bug导致权限不一致
2. 实现工作量大（4人日），超出MVP时间约束
3. WebSocket长连接管理复杂，可能导致内存泄漏

---

## 后果

### 正面影响

1. **权限安全性提升**：后端集中管理，权限泄露风险↓80%
   - 满足Epic §1.1"零P0级Bug"的安全目标
   - 无论前端如何篡改，后端仍会拒绝非授权请求

2. **开发简化**：标准的Spring Security框架能力
   - 工作量仅2人日，轻松纳入MVP
   - 代码复用性高，后续维护成本低

3. **审计追溯**：所有权限操作有详细日志
   - 便于安全分析和合规认证
   - 历史责任可追溯

### 负面影响与风险

| 风险ID | 风险描述 | 概率 | 影响 | 等级 | 应对措施 |
|--------|---------|------|------|------|---------|
| R1 | 权限变更后，用户缓存未刷新，UI显示错误（用户可访问他无权的菜单） | 中 | 中 | 🟡 | 设置缓存过期时间2小时自动刷新；前端每次调用API时检查权限有效性 |
| R2 | 拦截器规则遗漏，某个API未进行权限检查 | 低 | 高 | 🔴 | 代码审查100%覆盖所有API；使用AOP动态代理确保所有@RequestMapping都被拦截 |
| R3 | 权限查询性能差，导致API响应变慢 | 低 | 中 | 🟡 | 权限查询添加DB索引；使用Redis缓存（优先级P2）；性能监控告警 |
| R4 | JWT Token被盗取，攻击者可以冒充用户 | 低 | 高 | 🔴 | 使用HTTPS传输Token；设置Token过期时间8小时；实现Token黑名单机制 |
| R5 | 权限数据库表设计不规范，查询复杂导致N+1问题 | 中 | 中 | 🟡 | 表结构设计审查；添加适当索引（user_id, role_id）；测试时监控Query次数 |

---

## 回滚条件

### 触发条件（满足任一条件即触发权限机制评估）

#### 条件1：权限泄露事件

**量化指标**：用户访问了他无权限的资源（代码审查或渗透测试发现）

- **监控方式**：
  - 权限审计日志（记录所有权限拒绝事件403）
  - 代码审查时检查权限检查点
  - 渗透测试（Day 6）尝试越权访问

- **判定周期**：实时（发现立即上报）

- **责任人**：架构师 + 安全审查

- **触发阈值**：
  ```
  IF (unauthorized_access_detected == true) THEN immediate escalation
  ```

#### 条件2：性能不达标

**量化指标**：权限查询P95延迟>100ms 持续1天

- **监控方式**：
  - 后端记录每个权限查询的耗时
  - 日志系统统计P95值
  - 性能监控告警（Prometheus）

- **判定周期**：每日15:00统计

- **责任人**：后端核心开发

- **触发阈值**：
  ```
  IF (P95(permission_query_time) > 100ms) FOR 1 day THEN optimize
  ```

#### 条件3：拦截器覆盖不足

**量化指标**：代码审查发现>10%的权限敏感API未进行权限检查

- **监控方式**：
  - 代码审查时检查所有API是否有权限注解
  - 静态扫描工具（SonarQube）检测未受保护的API
  - 定期安全审计（每周）

- **判定周期**：每周一进行覆盖率评估

- **责任人**：代码审查者

- **触发阈值**：
  ```
  IF (unprotected_api_ratio > 10%) THEN code review escalation
  ```

### 回滚/增强方案

#### 方案1：添加Redis缓存

**何时执行**：触发条件R3（性能不达标）

**执行步骤**：
1. 配置Redis连接（预计0.5小时）
2. 实现权限缓存逻辑（2小时）
3. 缓存过期和刷新机制（1小时）
4. 性能测试（1.5小时）

**总执行时间**：5小时

**预期性能提升**：P95延迟 100ms → 10ms（↓90%）

#### 方案2：强化权限拦截器

**何时执行**：触发条件R2（拦截器规则遗漏）或R1（权限泄露事件）

**执行步骤**：
1. 全量API扫描，统计权限检查覆盖率（2小时）
2. 为未受保护的API添加权限注解（2小时）
3. 使用AOP动态代理加固拦截器（2小时）
4. 回归测试（2小时）

**总执行时间**：8小时

**预期覆盖率**：从85% → 100%

#### 方案3：迁移前后端同步方案

**何时执行**：权限变更频率过高（>10次/天），强制重新登录影响用户体验

**执行步骤**：
1. 添加Redis订阅-发布（Pub/Sub）（3小时）
2. 前端添加WebSocket监听权限变更事件（4小时）
3. 自动权限刷新逻辑（2小时）
4. 测试和优化（3小时）

**总执行时间**：1.5天（12小时）

**触发条件**：V2版本（MVP不需要）

---

## 权限矩阵详解

### 用户-角色关联（多对多）

```
user_role 表：
┌─────────────┬─────────┬──────────────────┬─────────────────┐
│ user_id     │ role_id │ assigned_at      │ assigned_by     │
├─────────────┼─────────┼──────────────────┼─────────────────┤
│ 1 (张三)    │ 1(ADM)  │ 2025-01-01 10:00 │ 0 (系统初始化)  │
│ 2 (李四)    │ 2(DSN)  │ 2025-01-06 14:30 │ 1 (张三)        │
│ 2 (李四)    │ 3(VW)   │ 2025-01-06 14:31 │ 1 (张三)        │
│ 3 (王五)    │ 3(VW)   │ 2025-01-06 14:32 │ 1 (张三)        │
└─────────────┴─────────┴──────────────────┴─────────────────┘

说明：
- 张三（user_id=1）：ADMIN角色，管理系统
- 李四（user_id=2）：DESIGNER+VIEWER两个角色，可设计报表也可查看
- 王五（user_id=3）：VIEWER角色，仅可查看报表
```

### 报表-角色关联（多对多）

```
report_role 表：
┌────────────┬─────────┬──────────────────┬─────────────────┐
│ report_id  │ role_id │ assigned_at      │ assigned_by     │
├────────────┼─────────┼──────────────────┼─────────────────┤
│ 1 (销售)   │ 2(DSN)  │ 2025-01-06 15:00 │ 1 (张三)        │
│ 1 (销售)   │ 3(VW)   │ 2025-01-06 15:00 │ 1 (张三)        │
│ 2 (库存)   │ 2(DSN)  │ 2025-01-06 15:30 │ 1 (张三)        │
│ 2 (库存)   │ 3(VW)   │ 2025-01-06 15:30 │ 1 (张三)        │
│ 3 (财务)   │ 2(DSN)  │ 2025-01-06 16:00 │ 1 (张三)        │
└────────────┴─────────┴──────────────────┴─────────────────┘

说明：
- 销售报表（report_id=1）：分配给DESIGNER和VIEWER
- 库存报表（report_id=2）：分配给DESIGNER和VIEWER
- 财务报表（report_id=3）：仅分配给DESIGNER（财务敏感）
```

### 权限决策规则

```
当用户访问报表时，后端执行以下检查：

// 获取用户的所有角色
SELECT role_id FROM user_role WHERE user_id = ?

// 检查报表是否分配给这些角色
SELECT COUNT(*) FROM report_role 
WHERE report_id = ? AND role_id IN (用户的所有角色)

// 如果COUNT > 0，则有权限访问；否则返回403 Forbidden

// 权限继承规则
IF user.role == ADMIN THEN
  // Admin可以访问所有报表（不需要report_role表中的记录）
  允许访问
ELSE IF report_id IN user的授权报表 THEN
  允许访问
ELSE
  拒绝访问（403 Forbidden）
```

---

## 实施路线图

### 第1阶段：基础实施（Day 1-2）

```
1. 数据库表设计（user_role, report_role）（0.25人日）
2. Spring Security拦截器实现（0.75人日）
3. 权限校验注解实现（0.5人日）
4. 权限矩阵常数定义（0.5人日）
```

### 第2阶段：集成验证（Day 3）

```
1. 所有API权限检查验证（0.5人日）
2. 权限继承规则测试（0.25人日）
3. 权限审计日志实现（0.25人日）
```

### 第3阶段：安全测试（Day 6）

```
1. 渗透测试（尝试越权访问）（0.5人日）
2. 权限覆盖率评估（0.25人日）
3. 安全报告和改进（0.25人日）
```

---

## 相关文档

- **需求文档**：[Epic分析 §2.1 模块F](./doc/prompts/Epic分析-程序员报表生成工具.md)
- **用户故事**：[US-012~US-016 权限相关](./doc/用户故事拆解-程序员报表生成工具MVP.md)
- **相关ADR**：[ADR-001 架构设计](./ADR-001-技术栈选型与架构决策.md)
- **技术实施**：【待编写】Spring Security权限实施指南
- **数据库设计**：【待编写】权限表结构详细设计
- **测试计划**：【待编写】权限安全性测试计划

---

**文档状态**：✅ 已接受 | **最后更新**：2025-12-26 | **审核人**：架构团队
