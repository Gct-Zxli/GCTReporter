# 程序员报表生成工具 MVP - 用户故事拆解

> **📌 文档说明**：本文档基于《Epic分析-程序员报表生成工具.md》，遵循敏捷开发标准，生成可直接用于迭代开发的用户故事列表。
> **创建日期**: 2025-12-26
> **故事总数**: 20个（核心功能14个 + 技术故事3个 + 优化故事3个）

---

## 📊 用户故事总览

| 故事ID  | 故事标题            | 用户角色 | 功能分组     | 端口   | 粒度 | 优先级 |
| ------- | ------------------- | -------- | ------------ | ------ | ---- | ------ |
| US-001  | SQL编写与参数定义   | Designer | SQL查询管理  | 设计端 | M    | P0     |
| US-002  | 查询安全校验        | Designer | SQL查询管理  | 设计端 | M    | P0     |
| US-003  | 查询执行与结果预览  | Designer | SQL查询管理  | 设计端 | M    | P0     |
| US-004  | 列属性自定义配置    | Designer | 报表模板设计 | 设计端 | M    | P0     |
| US-005  | 数据格式化设置      | Designer | 报表模板设计 | 设计端 | M    | P0     |
| US-006  | 报表预览与调试      | Designer | 报表预览     | 设计端 | L    | P0     |
| US-007  | 报表权限分配        | Designer | 报表预览     | 管理端 | M    | P1     |
| US-008  | 查看授权报表列表    | Viewer   | 报表查询     | 用户端 | M    | P0     |
| US-009  | 参数输入与查询执行  | Viewer   | 报表查询     | 用户端 | M    | P0     |
| US-010  | 查询结果分页与排序  | Viewer   | 报表查询     | 用户端 | S    | P0     |
| US-011  | Excel导出与行数限制 | Viewer   | 数据导出     | 用户端 | M    | P1     |
| US-012  | 用户与角色管理      | Admin    | 权限管理     | 管理端 | L    | P0     |
| US-013  | 报表与角色权限分配  | Admin    | 权限管理     | 管理端 | M    | P0     |
| US-014  | 用户登录与认证      | All      | 认证框架     | 全端   | M    | P0     |
| TS-001  | 数据库表结构设计    | Dev Team | 基础设施     | 后端   | M    | P0     |
| TS-002  | 权限拦截器实现      | Dev Team | 基础设施     | 全端   | L    | P0     |
| TS-003  | API契约与文档编写   | Dev Team | 基础设施     | 全端   | M    | P0     |
| OPT-001 | 查询性能优化        | Dev Team | 性能优化     | 后端   | M    | P1     |
| OPT-002 | 前端表格渲染优化    | Dev Team | 性能优化     | 前端   | M    | P1     |
| OPT-003 | 权限缓存同步        | Dev Team | 性能优化     | 全端   | M    | P1     |

**统计信息**

- **故事总数**: 20个
- **角色分布**: Designer(6个), Viewer(4个), Admin(2个), All(1个), Dev Team(7个)
- **端口分布**: 设计端(6个), 用户端(4个), 管理端(2个), 全端(3个), 后端(3个), 前端(1个), 其他(1个)
- **粒度分布**: S(1个), M(14个), L(5个)
- **优先级分布**: P0(15个), P1(5个)

---

## 🎯 详细故事列表

---

## 功能分组1：SQL查询管理（设计端核心）

### US-001: SQL编写与参数定义

**用户故事**

> 作为 **报表设计者（Designer）**，
> 我希望 **能够输入SQL查询语句并定义查询参数**，
> 以便 **支持参数化查询，满足不同场景的数据查询需求**。

**功能要点**

- 输入SQL查询语句（仅支持SELECT）
- 定义查询参数（参数名、类型、默认值、是否必填）
- 支持参数占位符格式：`#{paramName}`
- 参数类型支持：String、Integer、Date、Decimal、Boolean
- 参数可设置默认值
- 参数支持标记为必填或可选
- 保存SQL模板供后续重用

**业务规则**

- 仅允许SELECT语句（非SELECT语句应被系统拒绝）
- 参数占位符必须使用 `#{paramName}` 格式
- 参数名称必须唯一且遵循命名规范（字母/数字/下划线）
- 最多支持100个查询参数

**界面要求**

- 提供SQL编辑器（代码高亮、自动缩进）
- 参数定义表单，支持动态增删参数行
- 参数预设值编辑
- SQL模板命名和保存按钮

**粒度评估**: **M (Medium)** - 3-5天工作量

- 后端：SQL语句验证、参数解析、持久化（2人日）
- 前端：编辑器集成、参数表单（1.5人日）

**依赖关系**

- 无依赖（基础功能）

**验收标准**

- ✅ 支持输入SQL SELECT语句
- ✅ 参数定义表单功能完整
- ✅ 支持5种参数类型
- ✅ 参数默认值可配置
- ✅ SQL模板保存成功
- ✅ 参数占位符识别正确

---

### US-002: 查询安全校验

**用户故事**

> 作为 **报表设计者（Designer）**，
> 我希望 **系统能够自动检查SQL语句中的安全风险**，
> 以便 **防止恶意SQL注入攻击，保护数据库安全**。

**功能要点**

- 黑名单关键字检查（DROP、DELETE、TRUNCATE、UPDATE、INSERT、ALTER、CREATE等）
- 检测是否为纯SELECT语句
- 检测SQL长度限制（最多10000字符）
- 显示清晰的安全警告提示
- 实时校验反馈
- 禁止不安全的SQL执行

**业务规则**

- 严禁包含DML语句（INSERT/UPDATE/DELETE/DROP/TRUNCATE）
- 严禁包含DDL语句（ALTER/CREATE/TRUNCATE）
- 严禁包含系统管理命令（EXEC/EXECUTE）
- 严禁包含脚本语言（JavaScript/Python等）
- 参数占位符必须使用PreparedStatement方式绑定
- 查询超时限制为5秒

**界面要求**

- SQL编辑器下方显示实时校验结果
- 安全警告以红色高亮展示
- 检测到危险关键字时禁用执行按钮
- 提供安全建议提示

**粒度评估**: **M (Medium)** - 3-5天工作量

- 后端：SQL安全校验模块（2人日）
- 前端：校验结果展示、交互反馈（1人日）

**依赖关系**

- 依赖: US-001 (SQL编写)

**技术约束**

- 使用正则表达式进行关键字检查
- 实现一个专用的SQL安全校验服务类
- 配置可扩展的关键字黑名单

**验收标准**

- ✅ 成功检测DROP/DELETE等危险关键字
- ✅ 检测到危险操作时禁止执行
- ✅ 清晰的错误提示信息
- ✅ 校验不影响性能（<200ms）
- ✅ 支持通过安全校验的SELECT语句
- ✅ 测试用例覆盖常见SQL注入攻击

---

### US-003: 查询执行与结果预览

**用户故事**

> 作为 **报表设计者（Designer）**，
> 我希望 **能够执行SQL查询并预览结果**，
> 以便 **快速验证SQL和参数配置的正确性，支持设计阶段的调试**。

**功能要点**

- 执行SQL查询语句
- 显示查询结果数据（表格格式）
- 显示列元数据（字段名、数据类型）
- 分页展示结果（每页100条）
- 支持多次执行调试
- 执行成功/失败的清晰反馈
- 显示查询耗时
- 显示返回的数据行数

**业务规则**

- 查询超时为5秒，超时自动中止
- 单次查询最多返回10000行（防止前端卡顿）
- 查询异常时显示友好的错误信息
- 使用只读数据库账号执行查询（权限最小化）

**界面要求**

- 执行按钮位置显眼
- 结果表格动态显示列结构
- 分页控件显示总行数和当前页
- 加载状态显示（Loading提示）
- 错误信息清晰提示

**粒度评估**: **M (Medium)** - 3-5天工作量

- 后端：查询执行引擎、超时控制、数据转换（2人日）
- 前端：结果表格显示、分页（1.5人日）

**依赖关系**

- 依赖: US-002 (安全校验)

**技术约束**

- PreparedStatement参数绑定
- 连接池管理
- 查询超时设置（Statement.setQueryTimeout）
- 异常捕获和处理

**验收标准**

- ✅ SQL执行成功并返回数据
- ✅ 结果表格显示所有列和行
- ✅ 分页正确，总行数准确
- ✅ 查询时间显示准确
- ✅ 超过5秒自动超时中止
- ✅ 超过10000行提示警告
- ✅ 执行失败显示错误原因

---

## 功能分组2：报表模板设计（设计端核心）

### US-004: 列属性自定义配置

**用户故事**

> 作为 **报表设计者（Designer）**，
> 我希望 **能够对查询结果的列进行自定义配置**，
> 以便 **优化报表展现效果，提升用户体验**。

**功能要点**

- 自定义显示名称（与数据库字段名不同）
- 设置列宽（像素值，范围50-500px）
- 调整列顺序（拖拽或上下移动）
- 隐藏不需要显示的列
- 显示/隐藏列切换
- 列配置的保存和加载
- 重置为默认配置

**业务规则**

- 至少显示一列（不能全部隐藏）
- 列宽最小50px，最大500px
- 显示名称最多50个字符
- 列顺序变化后自动保存到报表模板
- 列配置以JSON格式存储

**界面要求**

- 列配置表格，包含：字段名、显示名称、列宽、显示状态
- 拖拽排序或上下移动按钮
- 显示/隐藏的开关切换
- 列宽采用slider控件或输入框
- 保存和重置按钮

**粒度评估**: **M (Medium)** - 3-5天工作量

- 后端：列配置持久化、JSON序列化（1.5人日）
- 前端：配置表单UI、拖拽排序（1.5人日）

**依赖关系**

- 依赖: US-003 (查询执行)

**验收标准**

- ✅ 自定义显示名称保存成功
- ✅ 列宽在范围内可设置
- ✅ 列顺序拖拽有效
- ✅ 隐藏列后预览不显示
- ✅ 配置持久化到数据库
- ✅ 重新加载报表保留配置

---

### US-005: 数据格式化设置

**用户故事**

> 作为 **报表设计者（Designer）**，
> 我希望 **能够对不同数据类型的列进行格式化**，
> 以便 **提高报表数据的可读性和专业度**。

**功能要点**

- 日期格式化（支持多种日期格式）
  - yyyy-MM-dd
  - yyyy/MM/dd
  - dd-MM-yyyy
  - 自定义格式
- 数字格式化
  - 整数显示
  - 小数位数（1-4位）
  - 千位符（,）
- 货币格式化
  - 货币符号选择（$、¥、€等）
  - 小数位数
- 百分比格式化
- 自动类型检测

**业务规则**

- 格式化仅影响显示，不改变原始数据
- Excel导出时保留格式化效果
- 格式化错误时降级显示原始值
- 支持预览格式化结果

**界面要求**

- 列配置中添加"格式化类型"下拉选择
- 格式化示例展示
- 参数输入（小数位、符号等）
- 预览区显示格式化后的效果

**粒度评估**: **M (Medium)** - 3-5天工作量

- 后端：格式化引擎、格式规则定义（1.5人日）
- 前端：格式化参数配置UI（1.5人日）

**依赖关系**

- 依赖: US-004 (列属性配置)

**技术约束**

- 使用SimpleDateFormat进行日期格式化
- 使用DecimalFormat进行数字格式化
- 前端使用相应的格式化库

**验收标准**

- ✅ 日期格式化显示正确
- ✅ 数字千位符显示正确
- ✅ 小数位数控制准确
- ✅ 货币符号显示正确
- ✅ 格式化预览结果准确
- ✅ Excel导出保留格式化

---

## 功能分组3：报表预览与调试（设计端核心）

### US-006: 报表预览与调试

**用户故事**

> 作为 **报表设计者（Designer）**，
> 我希望 **能够在设计阶段实时预览报表效果**，
> 以便 **快速迭代验证SQL、参数和列配置，减少开发周期**。

**功能要点**

- 前端表格动态展示查询结果
- 参数表单自动生成（根据SQL参数）
- 实时参数输入和查询执行
- 分页展示（每页100条）
- 列头点击排序
- 多次调试执行支持
- 参数默认值自动填充
- 查询状态和性能指标显示

**业务规则**

- 预览仅在设计端可见（ADMIN和DESIGNER角色）
- 参数表单根据参数类型动态生成控件
- 参数值有效性校验（日期格式、数字范围等）
- 支持必填参数校验
- 查询结果实时更新无需刷新页面

**界面要求**

- 左侧：参数输入表单
- 右侧：查询结果表格
- 表单上方：执行/重置按钮
- 表格下方：分页控件
- 加载状态指示
- 错误提示显示

**粒度评估**: **L (Large)** - 5-10天工作量

- 后端：参数解析、动态SQL生成、查询执行（2人日）
- 前端：参数表单生成、表格渲染、分页排序（3人日）

**依赖关系**

- 依赖: US-005 (数据格式化)
- 依赖: TS-001 (数据库设计)

**验收标准**

- ✅ 参数表单动态生成正确
- ✅ 查询结果表格显示完整
- ✅ 分页和排序功能正常
- ✅ 多次执行结果一致
- ✅ 参数默认值自动填充
- ✅ 必填参数校验有效
- ✅ 查询性能指标显示准确

---

### US-007: 报表权限分配

**用户故事**

> 作为 **报表设计者（Designer）**，
> 我希望 **能够为创建的报表分配访问权限给不同角色**，
> 以便 **控制报表的可见范围，保护敏感数据安全**。

**功能要点**

- 选择报表
- 选择要授权的角色（ADMIN、DESIGNER、VIEWER）
- 支持多角色授权
- 取消角色授权
- 查看当前报表的权限分配情况
- 权限分配历史记录（可选）

**业务规则**

- 报表创建者自动拥有编辑权限
- 一个报表可以分配给多个角色
- ADMIN角色自动拥有所有报表权限（无需配置）
- 权限分配立即生效
- 权限变更记录审计日志

**界面要求**

- 报表详情页面中的"权限管理"标签
- 角色列表多选框
- 保存和取消按钮
- 当前权限分配状态展示

**粒度评估**: **M (Medium)** - 3-5天工作量

- 后端：权限关联表操作、权限继承逻辑（1.5人日）
- 前端：权限配置UI、多选组件（1人日）

**依赖关系**

- 依赖: US-006 (报表预览)
- 依赖: TS-002 (权限拦截器)

**验收标准**

- ✅ 支持多角色授权
- ✅ 权限分配立即生效
- ✅ 取消授权功能正常
- ✅ ADMIN自动拥有所有权限
- ✅ 权限变更有审计记录

---

## 功能分组4：报表查询（用户端核心）

### US-008: 查看授权报表列表

**用户故事**

> 作为 **普通用户（Viewer）**，
> 我希望 **能够查看自己有权限访问的报表列表**，
> 以便 **快速找到需要的报表进行查询**。

**功能要点**

- 显示当前用户有权限的所有报表
- 报表列表包含：报表名称、描述、创建人、创建时间
- 按报表名称搜索
- 按创建时间排序
- 点击进入报表查询页面
- 权限校验（仅显示授权报表）

**业务规则**

- ADMIN角色显示所有报表
- DESIGNER角色显示分配给DESIGNER的报表 + 创建的报表
- VIEWER角色显示分配给VIEWER的报表
- 列表分页显示（每页20个）
- 搜索结果实时返回

**界面要求**

- 报表列表表格或卡片布局
- 搜索框在顶部
- 报表信息完整显示
- 点击行进入查询页面
- 无权报表不显示

**粒度评估**: **M (Medium)** - 3-5天工作量

- 后端：权限过滤、列表查询、搜索（1.5人日）
- 前端：列表UI、搜索交互（1.5人日）

**依赖关系**

- 依赖: TS-002 (权限拦截器)

**验收标准**

- ✅ 仅显示有权报表
- ✅ 列表信息完整
- ✅ 搜索功能正常
- ✅ 排序功能正常
- ✅ 分页功能正常
- ✅ 点击进入查询页面

---

### US-009: 参数输入与查询执行

**用户故事**

> 作为 **普通用户（Viewer）**，
> 我希望 **能够输入查询参数并执行报表查询**，
> 以便 **获取符合条件的数据结果**。

**功能要点**

- 选择报表后进入查询页面
- 显示报表详细信息（名称、描述）
- 自动生成参数输入表单
- 参数类型匹配对应的输入控件
- 参数值校验（必填、格式等）
- 执行查询并显示结果
- 参数历史记录（可选）

**业务规则**

- 必填参数必须填写后才能执行查询
- 参数值格式必须匹配定义的类型
- 查询超时为5秒
- 查询结果最多显示10000行
- 清空参数按钮恢复到默认值

**界面要求**

- 上半部分：报表信息 + 参数表单
- 下半部分：查询结果表格
- 执行/清空按钮位置显眼
- 参数表单分组（如有多个参数）
- 加载状态显示

**粒度评估**: **M (Medium)** - 3-5天工作量

- 后端：权限校验、参数处理、查询执行（1.5人日）
- 前端：参数表单生成、结果显示（1.5人日）

**依赖关系**

- 依赖: US-008 (报表列表)
- 依赖: TS-002 (权限拦截器)

**验收标准**

- ✅ 参数表单动态生成
- ✅ 参数校验有效
- ✅ 必填参数检查正常
- ✅ 查询执行成功
- ✅ 结果显示完整
- ✅ 参数默认值正确

---

### US-010: 查询结果分页与排序

**用户故事**

> 作为 **普通用户（Viewer）**，
> 我希望 **能够对查询结果进行分页浏览和列排序**，
> 以便 **灵活查看大量数据，快速找到需要的信息**。

**功能要点**

- 前端分页展示（每页100条）
- 分页控件：首页、上一页、下一页、末页、跳转
- 显示当前页码和总记录数
- 列头点击排序（升序/降序）
- 排序状态指示
- 支持多列排序（可选）

**业务规则**

- 分页在前端进行（无需后端重复查询）
- 排序同样在前端进行
- 最多显示10000行数据（多出部分提示用户）
- 分页状态保持（换页后参数不清空）

**界面要求**

- 表格动态列显示
- 分页控件在表格下方
- 排序按钮/icon在列头
- 当前页码高亮显示

**粒度评估**: **S (Small)** - 1-3天工作量

- 后端：无额外工作（复用已有查询）
- 前端：分页排序组件（1.5人日）

**依赖关系**

- 依赖: US-009 (查询执行)

**验收标准**

- ✅ 分页功能正常
- ✅ 跳转页码准确
- ✅ 列排序有效
- ✅ 排序状态清晰
- ✅ 显示总行数准确

---

## 功能分组5：数据导出（用户端增强）

### US-011: Excel导出与行数限制

**用户故事**

> 作为 **普通用户（Viewer）**，
> 我希望 **能够将查询结果导出为Excel文件**，
> 以便 **进一步分析数据或在其他系统中使用**。

**功能要点**

- 导出按钮位置显眼（在查询结果表格上方）
- 导出格式：.xlsx（Excel 2007+）
- 文件命名：报表名_YYYYMMDD.xlsx
- 包含表头（显示名称）和所有数据行
- 保留数据格式化（日期、数字、货币）
- 列宽与前端显示一致
- 行数限制提示（最多5000行）
- 超出限制提示用户优化查询条件

**业务规则**

- 导出最多5000行数据
- 仅导出当前查询结果的所有数据（不受分页影响）
- 导出文件仅包含显示的列（隐藏列不导出）
- 导出时间限制：<5秒
- 导出时禁用其他操作

**界面要求**

- Excel导出按钮
- 导出状态提示（Loading）
- 成功/失败消息提示
- 行数预检提示

**粒度评估**: **M (Medium)** - 3-5天工作量

- 后端：POI库集成、Excel生成、行数校验（2人日）
- 前端：导出按钮、状态提示（1人日）

**依赖关系**

- 依赖: US-010 (分页排序)

**技术约束**

- 使用Apache POI生成XSSFWorkbook
- 流式写入避免内存溢出
- 异常处理和超时控制

**验收标准**

- ✅ 生成合法的.xlsx文件
- ✅ 文件名格式正确
- ✅ 表头显示名称正确
- ✅ 数据完整无遗漏
- ✅ 格式化保留（日期/数字/货币）
- ✅ 超过5000行提示正确
- ✅ 导出时间<5秒

---

## 功能分组6：权限管理（管理端核心）

### US-012: 用户与角色管理

**用户故事**

> 作为 **系统管理员（Admin）**，
> 我希望 **能够管理系统用户和角色分配**，
> 以便 **控制不同用户的系统访问权限和功能权限**。

**功能要点**

- 创建用户（用户名、密码、邮箱）
- 编辑用户信息（邮箱、状态）
- 删除用户（逻辑删除，保留审计信息）
- 为用户分配角色（支持多角色）
- 撤销用户角色
- 用户列表查询和搜索
- 用户状态管理（启用/禁用）
- 密码重置功能

**业务规则**

- 用户名唯一，不区分大小写
- 密码最少8字符，需要包含字母和数字
- 一个用户可拥有多个角色
- Admin角色无法删除（至少保留一个管理员）
- 用户删除操作需要二次确认

**界面要求**

- 用户列表表格：用户名、邮箱、角色、状态、操作
- 新增用户对话框
- 编辑用户信息对话框
- 角色分配多选框
- 搜索和过滤功能

**粒度评估**: **L (Large)** - 5-10天工作量

- 后端：用户CRUD、角色关联、权限管理（3人日）
- 前端：用户管理UI、表单验证、对话框（2人日）

**依赖关系**

- 依赖: TS-001 (数据库设计)

**验收标准**

- ✅ 用户创建/编辑/删除功能正常
- ✅ 用户名唯一性校验
- ✅ 密码复杂度校验
- ✅ 角色分配正确
- ✅ 用户列表搜索正常
- ✅ 删除操作二次确认
- ✅ 审计日志记录

---

### US-013: 报表与角色权限分配

**用户故事**

> 作为 **系统管理员（Admin）**，
> 我希望 **能够配置报表对应的可访问角色**，
> 以便 **在设计端配置的基础上进行全局权限管理**。

**功能要点**

- 查看所有报表列表
- 选择报表进行权限配置
- 选择可访问的角色（ADMIN、DESIGNER、VIEWER）
- 支持多角色授权
- 取消角色授权
- 权限分配保存
- 权限冲突检查和提示

**业务规则**

- ADMIN角色自动拥有所有报表权限（不显示在配置中）
- 一个报表可分配给多个角色
- 报表创建者（Designer）自动拥有访问权限
- 权限变更立即生效
- 权限历史可追溯（审计日志）

**界面要求**

- 报表列表页面
- 每个报表右侧有"权限管理"按钮
- 权限配置对话框
- 角色多选框
- 保存和取消按钮

**粒度评估**: **M (Medium)** - 3-5天工作量

- 后端：权限关联、权限查询、冲突检查（1.5人日）
- 前端：权限管理UI、多选组件（1.5人日）

**依赖关系**

- 依赖: US-012 (用户角色管理)
- 依赖: TS-002 (权限拦截器)

**验收标准**

- ✅ 权限配置保存正确
- ✅ 多角色授权有效
- ✅ 权限变更立即生效
- ✅ 权限冲突检查准确
- ✅ 审计日志记录完整

---

## 功能分组7：认证与访问控制（全端通用）

### US-014: 用户登录与认证

**用户故事**

> 作为 **任何用户（Admin/Designer/Viewer）**，
> 我希望 **能够使用用户名和密码登录系统**，
> 以便 **访问自己有权限的功能和数据**。

**功能要点**

- 登录页面（用户名、密码输入框）
- 用户身份验证（数据库查询）
- 登录失败提示（账号不存在、密码错误）
- 登录成功后跳转到首页或权限对应的页面
- 登出功能
- 会话管理（Session或Token）
- 登录状态检查

**业务规则**

- 登录使用用户名（不区分大小写）
- 密码使用加密存储和验证
- 登录失败5次需要等待5分钟
- Session超时时间：30分钟无操作自动登出
- 登出清除会话信息

**界面要求**

- 登录页面样式简洁
- 用户名和密码输入框
- 登录和重置按钮
- 错误提示显示
- Logo和品牌信息

**粒度评估**: **M (Medium)** - 3-5天工作量

- 后端：认证服务、Session管理、密码加密（2人日）
- 前端：登录页面、登出按钮、状态维护（1人日）

**依赖关系**

- 无依赖（基础功能，但需先完成TS-001）

**技术约束**

- 密码使用BCrypt或MD5加盐加密
- Session/Token机制
- 登录状态拦截器

**验收标准**

- ✅ 登录成功跳转正确
- ✅ 登录失败提示准确
- ✅ 密码加密存储
- ✅ Session超时生效
- ✅ 登出清除会话
- ✅ 登录失败限制生效

---

## 功能分组8：基础设施（技术故事）

### TS-001: 数据库表结构设计

**用户故事**

> 作为 **开发团队**，
> 我需要 **设计和创建系统所需的数据库表结构**，
> 以便 **为所有功能模块提供数据持久化基础**。

**技术要点**

- 用户表 (user)
  - id, username, password, email, status, created_at, updated_at
- 角色表 (role)
  - id, role_name, description
- 用户角色关联表 (user_role)
  - user_id, role_id
- 报表表 (report)
  - id, name, description, sql_content, creator_id, created_at, updated_at
- 报表参数表 (report_param)
  - id, report_id, param_name, param_type, default_value, is_required
- 报表列配置表 (report_column)
  - id, report_id, field_name, display_name, column_width, format_type, sort_order
- 报表角色权限表 (report_role)
  - report_id, role_id
- 操作日志表 (audit_log)
  - id, user_id, operation, resource_type, resource_id, created_at

**设计要点**

- 所有表使用InnoDB引擎，支持事务
- 主键使用自增ID或UUID
- 创建时间戳字段
- 创建必要的索引（username, role_name等）
- 外键约束确保数据完整性
- 预定义三个角色：ADMIN、DESIGNER、VIEWER

**粒度评估**: **M (Medium)** - 3-5天工作量

- 数据库设计：2人日
- SQL脚本编写和验证：1人日

**验收标准**

- ✅ 所有表创建成功
- ✅ 字段类型和长度合理
- ✅ 索引创建完毕
- ✅ 外键约束正确
- ✅ 默认数据初始化（3个角色）
- ✅ 脚本可重复执行

---

### TS-002: 权限拦截器实现

**用户故事**

> 作为 **开发团队**，
> 我需要 **实现后端权限拦截器**，
> 以便 **在API层统一校验用户权限，防止权限绕过**。

**技术要点**

- Spring拦截器/过滤器实现
- 权限校验逻辑：
  - 检查用户登录状态
  - 获取用户角色
  - 检查角色对应的功能权限
  - 对于报表相关API，检查用户角色是否在报表的权限角色列表中
- 权限缓存机制
  - 用户登录时缓存其角色和权限报表列表
  - 权限变更时清除缓存
- 无权限返回403 Forbidden
- 权限变更由管理端触发，需要强制用户重新登录

**实现要点**

- 创建AuthInterceptor类
- 在Spring Boot中注册拦截器
- 权限配置表：记录哪些URL需要什么权限
- 缓存使用Redis或本地缓存（看性能要求）
- 异常处理返回统一的权限错误响应

**粒度评估**: **L (Large)** - 5-10天工作量

- 拦截器框架搭建：2人日
- 权限校验逻辑：2人日
- 缓存机制：1人日
- 测试和优化：1人日

**依赖关系**

- 依赖: TS-001 (数据库设计)

**验收标准**

- ✅ 拦截器正常工作
- ✅ 权限校验准确
- ✅ 无权操作返回403
- ✅ 权限缓存生效
- ✅ 权限变更实时生效
- ✅ 性能指标：<100ms

---

### TS-003: API契约与文档编写

**用户故事**

> 作为 **开发团队**，
> 我需要 **编写所有API的接口文档和契约**，
> 以便 **前后端能够准确对接，减少沟通成本**。

**技术要点**

- 使用Swagger/OpenAPI标准
- API端点文档包含：
  - URL路径
  - HTTP方法
  - 请求参数（Query、Body、Path）
  - 请求示例
  - 响应格式
  - 响应示例
  - 错误码定义
  - 权限要求
- 后端API列表：
  - 认证类（登录、登出）
  - 报表类（CRUD、权限管理）
  - 查询类（SQL执行、数据预览、导出）
  - 用户管理类（用户CRUD、角色分配）

**文档要点**

- 每个API单独文档
- 明确的请求/响应格式（JSON示例）
- 错误码定义表
- 权限要求说明
- 参数校验规则
- 性能指标（超时、响应时间等）

**粒度评估**: **M (Medium)** - 3-5天工作量

- API设计和定义：1.5人日
- Swagger配置和文档生成：1.5人日

**验收标准**

- ✅ 所有API文档完整
- ✅ Swagger页面可访问
- ✅ 请求/响应示例准确
- ✅ 错误码定义完整
- ✅ 权限要求明确

---

## 功能分组9：性能优化（优化故事）

### OPT-001: 查询性能优化

**用户故事**

> 作为 **开发团队**，
> 我需要 **优化SQL查询的执行性能**，
> 以便 **满足性能指标要求（1000行数据<3秒）**。

**优化要点**

- 数据库连接池优化
- SQL查询优化（索引、执行计划）
- 大数据量分页策略
- 缓存策略（可选，V2版本考虑）
- 查询结果数据结构优化

**验收标准**

- ✅ 1000行查询<3秒
- ✅ 列表加载<1秒
- ✅ 连接池配置合理
- ✅ 索引创建正确

**粒度评估**: **M** - 3-5天工作量

---

### OPT-002: 前端表格渲染优化

**用户故事**

> 作为 **开发团队**，
> 我需要 **优化前端大数据表格的渲染性能**，
> 以便 **提供流畅的用户体验**。

**优化要点**

- 虚拟滚动（大数据量分页）
- DOM节点优化
- 组件懒加载
- 样式计算优化

**粒度评估**: **M** - 3-5天工作量

---

### OPT-003: 权限缓存同步

**用户故事**

> 作为 **开发团队**，
> 我需要 **实现权限信息的缓存和同步机制**，
> 以便 **提高权限校验的性能，同时保证权限变更的实时性**。

**优化要点**

- 权限信息缓存（Redis/Local）
- 缓存失效策略
- 权限变更通知机制
- 缓存预热

**粒度评估**: **M** - 3-5天工作量

---

## 📋 故事优先级和排期建议

### 第一个迭代（第1-5个工作日）- Sprint 1

**迭代目标**: 完成设计端基础功能，支持SQL编写、模板设计和预览

**包含的故事**:

```
P0优先级:
  TS-001  数据库表结构设计 (开始日期：Day 1)
  US-014  用户登录与认证 (依赖TS-001，Day 2开始)
  US-001  SQL编写与参数定义 (并行，Day 1)
  US-002  查询安全校验 (Day 2)
  US-003  查询执行与结果预览 (Day 3)
  US-004  列属性自定义配置 (Day 4)
  US-005  数据格式化设置 (Day 4)
  US-006  报表预览与调试 (Day 5)
```

**迭代验收**:

- ✅ 数据库表结构创建完毕
- ✅ 用户登录功能可用
- ✅ 报表设计端能够完整支持报表创建、配置、预览
- ✅ 所有P0功能验收通过

**工作量预估**: 16人日 / 2人 = 8个工作日（考虑并行开发可在5天内完成）

---

### 第二个迭代（第6-10个工作日）- Sprint 2

**迭代目标**: 完成用户端查询和管理端权限管理功能，实现完整的三端架构

**包含的故事**:

```
P0优先级:
  TS-002  权限拦截器实现 (开始日期：Day 6)
  TS-003  API契约与文档编写 (Day 6)
  US-012  用户与角色管理 (Day 6)
  US-013  报表与角色权限分配 (Day 7)
  US-008  查看授权报表列表 (Day 8)
  US-009  参数输入与查询执行 (Day 8)
  US-010  查询结果分页与排序 (Day 9)

P1优先级:
  US-007  报表权限分配 (Day 9)
  US-011  Excel导出与行数限制 (Day 10)
```

**迭代验收**:

- ✅ 权限拦截器正常工作
- ✅ 管理端用户和角色管理功能完整
- ✅ 用户端能够查询授权报表
- ✅ Excel导出功能可用
- ✅ 权限隔离和访问控制生效

**工作量预估**: 16人日 + 优化 = 10个工作日（考虑Sprint 1经验，可在10个工作日内完成）

---

### 发布准备和优化（第11-14个工作日）

**预留时间用于**:

- Bug修复和缺陷处理
- 性能优化（OPT-001, OPT-002, OPT-003）
- 集成测试和用户验收测试
- 部署文档编写
- 性能基准测试

---

## 🎯 故事质量评估

### INVEST检查清单

| 检查项                          | 评价                                  |
| ------------------------------- | ------------------------------------- |
| **Independent（独立性）** | ✅ 大部分故事独立，少数有明确依赖关系 |
| **Negotiable（可协商）**  | ✅ 每个故事都有明确的验收标准         |
| **Valuable（有价值）**    | ✅ 所有故事都为用户提供业务价值       |
| **Estimable（可估）**     | ✅ 每个故事都有明确的工作量估计       |
| **Small（小）**           | ⚠️ 3个L级故事需要考虑进一步拆分     |
| **Testable（可测）**      | ✅ 所有故事都有清晰的验收标准         |

### 需要拆分的L级故事

1. **US-006 (报表预览与调试)** - 可拆分为：

   - US-006a: 参数表单自动生成
   - US-006b: 查询结果表格显示
   - US-006c: 分页和排序功能
2. **US-012 (用户与角色管理)** - 可拆分为：

   - US-012a: 用户CRUD
   - US-012b: 角色分配
   - US-012c: 密码重置和禁用
3. **TS-002 (权限拦截器实现)** - 可拆分为：

   - TS-002a: 认证拦截器
   - TS-002b: 权限校验逻辑
   - TS-002c: 权限缓存机制

---

## 📚 相关文档参考

- [Epic分析-程序员报表生成工具](./Epic分析-程序员报表生成工具.md) - Epic级需求分析
- [程序员报表生成工具-项目分析报告](../程序员报表生成工具-项目分析报告.md) - 详细的项目分析
- [INVEST评估提示词](./B4-03-INVEST评估提示词.md) - 用于进一步评估故事质量

---

## ✅ 文档完成度

- ✅ 用户故事总览表（20个故事）
- ✅ 详细故事列表（按功能分组）
- ✅ 每个故事包含完整信息（格式、要点、规则、界面、粒度、验收标准）
- ✅ 故事优先级和排期建议
- ✅ 迭代计划（2周Sprint）
- ✅ 故事质量评估（INVEST检查）
- ✅ L级故事拆分建议

---

**文档版本**: v1.0
**最后更新**: 2025-12-26
**作者**: AI敏捷分析
**审核状态**: ⏳ 待产品经理和技术团队审核

**下一步行动**:

1. 产品经理审核用户故事的业务价值和准确性
2. 技术团队评估工作量和技术风险
3. 可选：对L级故事进行进一步拆分
4. 确认迭代规划和排期
5. 准备Sprint 1的故事详细化工作（编写技术设计、数据库脚本等）
