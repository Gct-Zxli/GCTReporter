# ADR-001：技术栈选型与三端架构设计

| 属性 | 内容 |
|------|------|
| **ADR编号** | ADR-001 |
| **状态** | 已接受 |
| **决策日期** | 2025-12-26 |
| **决策人** | 架构团队 |
| **关联需求** | Epic: 程序员报表生成工具 MVP |
| **替代ADR** | 无 |

---

## 背景

### 业务需求

开发程序员报表生成工具MVP，支持三端架构（管理端、设计端、用户端），实现：
- SQL查询管理与参数化
- 报表模板设计与预览
- 权限控制RBAC
- Excel数据导出

**来源**：Epic分析 第一部分 §1.1

### 技术约束

| 约束项 | 具体内容 | 来源 |
|--------|---------|------|
| **时间** | MVP交付2周（10个工作日） | Epic §1.1 SMART目标 |
| **人力** | 2名资深开发人员（后端+前端） | Epic §1.2 工作量分布 |
| **工作量** | 总计20人日（16核心+4Buffer） | Epic §1.2 |
| **性能指标** | 查询<3秒、导出<5秒、列表<1秒 | Epic §1.1 SMART目标 |
| **可靠性** | 零P0级Bug（无数据泄露、SQL注入） | Epic §1.1 SMART目标 |

### 当前痛点

- 现有商业工具部署复杂，学习成本高
- 开发人员需要快速创建和共享SQL查询结果
- 权限管理体系不清晰，容易产生数据泄露风险

**来源**：Epic §1.1 业务背景

---

## 决策

### 核心方案选择

**技术栈**：
- **后端**：SpringBoot + MySQL 5.7+ + PreparedStatement
- **前端**：Vue 3 + TypeScript + Element Plus + Monaco Editor
- **部署**：三层独立部署（Admin端、Designer端、Viewer端）

**核心理由**：
使用成熟的Spring Boot和Vue生态，保证2周内快速交付。通过分离的三端部署降低权限风险，PreparedStatement防止SQL注入，MockServer支持离线开发。

---

## 候选方案

### 架构设计方案对比

| 维度 | 方案A：三端独立部署 | 方案B：单体应用 | 方案C：微服务架构 |
|------|------------------|-------------|------------|
| **开发周期** | 10天（推荐） | 8天 | 20+天 |
| **部署复杂度** | 低（3个独立应用） | 低（单个WAR） | 高（服务编排） |
| **权限隔离** | 高（三端物理隔离） | 中（代码级隔离） | 中（服务级隔离） |
| **扩展性** | 中（端之间独立） | 低（代码耦合） | 高（可单独扩展） |
| **运维成本** | 中（3个应用） | 低（1个应用） | 高（10+个服务） |
| **学习成本** | 低（CRUD应用） | 低（CRUD应用） | 高（分布式复杂度） |
| **风险等级** | 🟢 低 | 🟡 中 | 🟡 中 |

### 技术栈方案对比

| 维度 | 方案A：Spring+Vue | 方案B：Django+React | 方案C：Node+Next.js |
|------|-----------------|-------------------|-----------------|
| **团队熟悉度** | 高（Java/Vue主流） | 中（Python学习成本） | 中（Node新学习） |
| **生态成熟度** | 高（10年+） | 中（6年+） | 中（8年+） |
| **ORM&DB** | MyBatis最佳实践 | Django ORM简洁 | Sequelize复杂 |
| **前端UI库** | Element Plus（企业级） | Material-UI（功能全） | Tailwind（定制难） |
| **招聘难度** | 易（供给充足） | 难（Python供给少） | 难（Node供给少） |
| **部署环境** | JVM通用 | Python+Gunicorn | Node.js+PM2 |
| **成本估算** | 20人日 | 25人日 | 28人日 |

---

## 权衡分析

### 方案A：三端独立部署 + Spring + Vue

**✅ 优势**：

1. **权限隔离最好**：三个独立应用，权限泄露影响范围最小
   - Admin端泄露仅影响用户管理
   - Designer端泄露仅影响报表定义（但不能访问Viewer端数据）
   - 来源：Epic §2.1 模块F 权限矩阵设计

2. **开发效率高**：成熟框架和生态，2名开发人员10天可交付
   - Spring Boot内置Tomcat，开箱即用
   - Vue 3单文件组件开发效率高
   - Element Plus企业级组件完整
   - 来源：Epic §1.2 技术复杂度评估

3. **风险可控**：所有关键技术都有成熟的开源实现和商业支持
   - PreparedStatement是行业标准的SQL注入防护
   - MyBatis参数绑定经验丰富
   - 来源：Epic §3.1 技术风险评估

4. **运维部署简单**：三个独立WAR包，Docker容器化部署容易
   - 启动时间<10秒
   - 失败自动重启机制明确

**❌ 劣势**：

1. **部署成本稍高**：需要管理3个应用实例而不是1个
   - 日志聚合、监控告警配置3倍工作量
   - 缓解措施：使用ELK Stack统一日志，Prometheus统一监控（模板复用）
   - 来源：基于部署经验补充

2. **跨端数据流转复杂**：API契约需要明确定义
   - Designer端生成报表后，Viewer端需要获取完整配置
   - 缓解措施：所有API响应使用统一的DTO对象，OpenAPI自动生成文档
   - 来源：user story US-007（报表权限分配）

3. **共享缓存管理困难**：用户权限缓存在各端各自维护
   - 如果Admin端更新权限，Designer/Viewer端可能延迟同步
   - 缓解措施：权限变更时强制用户重新登录，或使用Redis共享缓存（优先级：P2）
   - 来源：Epic §3.2 多端权限同步风险

### 方案B：单体应用 + Spring + Vue

**✅ 优势**：

1. **开发速度快**：单代码库，共享的Service层和DAO层
   - 开发周期约8天（比方案A快2天）
   - 避免三端API定义的返工

2. **权限管理集中**：所有角色权限在一个系统中维护
   - 权限变更实时生效（无延迟同步问题）

**❌ 劣势**：

1. **权限隔离弱**：代码级权限控制容易绕过
   - 如果后端权限检查遗漏，高权限用户可能越权访问
   - 来源：Epic §3.1 权限隔离风险评估
   
2. **单点故障影响全部用户**：Admin端BUG会导致所有用户无法访问
   - 缓解措施：需要实现自动故障转移和快速回滚机制
   - 来源：user story US-010 权限校验

3. **扩展性受限**：如果未来需要高性能设计端，无法单独扩展
   - 缓解措施：架构预留微服务升级路径（但MVP不实现）
   - 来源：基于未来演进补充

### 方案C：微服务架构

**❌ 劣势**：开发周期20+天，超出MVP 10天的时间约束，不适合MVP阶段

---

## 后果

### 正面影响

1. **权限安全性提升**：三端物理隔离，权限泄露风险↓50%
   - Admin端被攻击不会直接导致用户数据泄露
   - 满足Epic §1.1中"零P0级Bug"的安全目标

2. **快速交付**：使用成熟技术栈，2名开发人员10天可交付
   - 符合MVP时间约束（Epic §1.1）
   - 留下4人日Buffer用于Bug修复和集成测试

3. **团队技能对齐**：Java和Vue是主流技术，招聘和知识转移容易
   - 后续V2版本不需要重新选型学习

### 负面影响与风险

| 风险ID | 风险描述 | 概率 | 影响 | 等级 | 应对措施 |
|--------|---------|------|------|------|---------|
| R1 | 三端API契约不清晰导致集成返工 | 中 | 中 | 🟡 | 第1天完成API文档编写，使用OpenAPI Swagger验证 |
| R2 | SQL注入攻击（使用了PreparedStatement但规则不完整） | 低 | 高 | 🔴 | 黑名单关键字检查+PreparedStatement+只读DB账号 |
| R3 | 权限缓存不同步导致权限泄露 | 低 | 高 | 🔴 | 权限变更强制用户重新登录；V2考虑Redis共享缓存 |
| R4 | 报表配置JSON过大导致网络传输慢 | 中 | 低 | 🟢 | 列配置gzip压缩；分页加载；MonacoEditor代码高亮不传输到前端 |
| R5 | 跨端发版兼容性问题 | 低 | 中 | 🟡 | API版本号控制；向后兼容策略 |

---

## 回滚条件

### 触发条件（满足任一条件即触发架构回滚评估）

#### 条件1：性能不达标

**量化指标**：任一端点P95延迟>3秒（查询）或>5秒（导出）持续2天

- **监控方式**：
  - 后端使用Spring Boot Actuator暴露性能指标
  - 前端使用Navigation Timing API记录端到端延迟
  - 日志记录每次请求的耗时分布（P50/P95/P99）

- **判定周期**：每日15:00统计前一天的性能数据

- **责任人**：后端核心开发

- **触发阈值**：
  ```
  IF (P95(query_time) > 3000ms) FOR 2 days THEN review architecture
  ```

#### 条件2：权限泄露事件

**量化指标**：发生任何用户越权访问数据的事件（经过代码审查确认的权限绕过）

- **监控方式**：
  - 权限审计日志记录所有用户操作
  - 代码审查时检查权限校验点
  - 定期渗透测试（Day 6）

- **判定周期**：实时（发现立即上报）

- **责任人**：架构师 + 前端负责人

- **触发阈值**：
  ```
  IF (unauthorized_access_event == true) THEN immediately escalate
  ```

#### 条件3：SQL注入风险

**量化指标**：代码审查或静态分析检测出SQL注入风险点（未使用PreparedStatement的动态SQL）

- **监控方式**：
  - SonarQube扫描检测SQL拼接代码
  - 代码审查时100%检查SQL相关代码
  - 黑盒测试尝试注入攻击

- **判定周期**：每次代码提交（CI/CD阶段）

- **责任人**：代码评审者

- **触发阈值**：
  ```
  IF (sonarqube_security_rating < A) THEN block merge
  ```

### 回滚方案

#### 备选方案1：切换为单体应用架构（如果权限隔离问题出现）

**执行步骤**：
1. 将三端Controller合并到单个Spring Boot应用（预计2小时）
2. 统一数据源和权限检查逻辑（预计2小时）
3. 前端路由统一到同一服务器（预计1小时）
4. 回归测试（预计4小时）

**总回滚时间**：1天（9小时）

**触发条件**：`R3（权限缓存不同步导致权限泄露）`

#### 备选方案2：性能优化迭代

**执行步骤**：
1. 添加Redis缓存层缓存热数据（预计4小时）
2. 数据库查询优化（索引、分页）（预计4小时）
3. 前端懒加载和虚拟滚动（预计4小时）
4. 重新性能测试（预计2小时）

**总回滚时间**：1.5天（14小时）

**触发条件**：`R1（性能不达标）`

#### 备选方案3：强化SQL安全（如果检测出注入风险）

**执行步骤**：
1. 全量代码审查（使用正则扫描动态SQL）（预计4小时）
2. 实施黑名单关键字检查（DROP/DELETE等）（预计2小时）
3. 切换到只读数据库账号（预计1小时）
4. 安全性测试（尝试注入攻击）（预计4小时）

**总回滚时间**：1.5天（11小时）

**触发条件**：`R2（SQL注入风险）`

---

## 相关文档

- **需求文档**：[Epic分析-程序员报表生成工具.md](./doc/prompts/Epic分析-程序员报表生成工具.md)
- **用户故事**：[用户故事拆解-程序员报表生成工具MVP.md](./doc/用户故事拆解-程序员报表生成工具MVP.md)
- **技术设计**：【待编写】数据库表结构设计文档
- **API文档**：【待编写】三端API接口规范
- **安全审查**：【待执行】Day 2 代码安全审查
- **性能基准**：【待执行】Day 6 性能基准测试报告

---

**文档状态**：✅ 已接受 | **最后更新**：2025-12-26 | **审核人**：架构团队
