# TS-001 数据库表结构设计 - 实施指南

> **📌 文档说明**：TS-001任务的完整实施指南，包含步骤、验证方法和常见问题
> **创建日期**: 2025-12-26
> **版本**: v1.0
> **关联任务**: Sprint Backlog 中的 T1-T10

---

## 📋 任务概览

**任务ID**: TS-001  
**任务名称**: 数据库表结构设计  
**优先级**: 🔴 P0 (最高)  
**预期工作量**: 10.3小时 (1.3天)  
**前置依赖**: 无  
**后置依赖**: 所有其他故事  
**责任人**: 后端开发  

---

## 🎯 任务目标

1. ✅ 完成所有8个核心表的设计和创建
2. ✅ 设置合理的索引，确保查询性能
3. ✅ 初始化系统基础数据（3个角色、3个测试用户）
4. ✅ 生成完整的数据库文档（数据字典）
5. ✅ 在本地、测试、生产环境验证脚本可执行

---

## 📚 子任务分解

### T1: ER图设计（1小时）

**目标**: 设计系统的表结构和关系图

**步骤**:
1. 列出所有表：role, user, user_role, report, report_param, report_column, report_role, audit_log
2. 定义表间关系：
   - user_role: user ←多对多→ role
   - report_column: report ←一对多→ column配置
   - report_param: report ←一对多→ param定义
   - report_role: report ←多对多→ role（权限）
   - audit_log: ←记录所有操作

3. 绘制ER图（使用PowerDesigner、Lucidchart或PlantUML）

**验证标准**:
- ✅ 所有表都在ER图中显示
- ✅ 关系线清晰，标注外键关系
- ✅ 主键、唯一键、索引都标注

**输出物**: ER图文件（PDF或PNG）

---

### T2: 表结构定义（1.5小时）

**目标**: 定义每个表的字段、类型、约束

**步骤**:

1. **role表**: 5个字段
   ```
   id (INT PK)
   role_name (VARCHAR 50 UNIQUE)
   description (VARCHAR 255)
   created_at (TIMESTAMP)
   updated_at (TIMESTAMP)
   ```

2. **user表**: 7个字段
   ```
   id (BIGINT PK)
   username (VARCHAR 50 UNIQUE)
   password (VARCHAR 255)
   email (VARCHAR 100)
   status (INT)
   created_at (TIMESTAMP)
   updated_at (TIMESTAMP)
   ```

3. **user_role表**: 2个字段（多对多）
   ```
   user_id (BIGINT FK)
   role_id (INT FK)
   PK: (user_id, role_id)
   ```

4. **report表**: 7个字段
   ```
   id (BIGINT PK)
   name (VARCHAR 100)
   description (TEXT)
   sql_content (LONGTEXT)
   creator_id (BIGINT FK)
   created_at (TIMESTAMP)
   updated_at (TIMESTAMP)
   ```

5. **report_param表**: 7个字段
   ```
   id (BIGINT PK)
   report_id (BIGINT FK)
   param_name (VARCHAR 50)
   param_type (VARCHAR 20)
   default_value (VARCHAR 255)
   is_required (BOOLEAN)
   created_at (TIMESTAMP)
   UNIQUE: (report_id, param_name)
   ```

6. **report_column表**: 9个字段
   ```
   id (BIGINT PK)
   report_id (BIGINT FK)
   field_name (VARCHAR 100)
   display_name (VARCHAR 100)
   column_width (INT)
   format_type (VARCHAR 20)
   sort_order (INT)
   is_visible (BOOLEAN)
   created_at (TIMESTAMP)
   UNIQUE: (report_id, field_name)
   ```

7. **report_role表**: 3个字段（多对多权限）
   ```
   report_id (BIGINT FK)
   role_id (INT FK)
   created_at (TIMESTAMP)
   PK: (report_id, role_id)
   ```

8. **audit_log表**: 7个字段
   ```
   id (BIGINT PK)
   user_id (BIGINT FK, nullable)
   operation (VARCHAR 50)
   resource_type (VARCHAR 50)
   resource_id (VARCHAR 100)
   details (LONGTEXT)
   created_at (TIMESTAMP)
   ```

**验证标准**:
- ✅ 所有字段类型和长度合理
- ✅ 主键、外键、唯一键定义清楚
- ✅ 默认值设置合理（如created_at、status）

**输出物**: 表结构定义文档

---

### T3: 索引设计（1小时）

**目标**: 确定需要创建哪些索引，提高查询性能

**关键索引清单**:

| 表名 | 索引名 | 字段 | 类型 | 说明 |
|------|--------|------|------|------|
| role | idx_role_name | role_name | INDEX | 加速角色名查询 |
| role | idx_created_at | created_at | INDEX | 加速时间排序 |
| user | idx_username | username | INDEX | **热点**：加速登录查询 |
| user | idx_email | email | INDEX | 加速邮箱查询 |
| user | idx_status | status | INDEX | 加速启用/禁用查询 |
| user | idx_created_at | created_at | INDEX | 加速时间排序 |
| user_role | idx_role_id | role_id | INDEX | 反向查询：某角色的用户 |
| report | idx_creator_id | creator_id | INDEX | 加速用户报表查询 |
| report | idx_created_at | created_at | INDEX | 加速时间范围查询 |
| report | idx_name | name | INDEX | 加速报表名搜索 |
| report_param | idx_report_id | report_id | INDEX | 加速参数查询 |
| report_column | idx_report_id | report_id | INDEX | 加速列配置查询 |
| report_role | idx_role_id | role_id | INDEX | 反向查询：某角色授权的报表 |
| audit_log | idx_user_id | user_id | INDEX | 加速用户操作历史查询 |
| audit_log | idx_created_at | created_at | INDEX | **热点**：加速日期查询和清理 |
| audit_log | idx_operation | operation | INDEX | 加速操作类型查询 |
| audit_log | idx_resource_type | resource_type | INDEX | 加速资源类型查询 |
| audit_log | idx_resource_id | resource_id | INDEX | 加速资源ID查询 |

**性能优化建议**:
- idx_username: 登录时频繁查询，必须有
- idx_created_at (audit_log): 清理日志时高频使用，必须有
- idx_creator_id (report): 报表列表查询频繁，必须有
- 复合索引(report_id, field_name): 提高查询效率

**验证标准**:
- ✅ 所有热点字段都有索引
- ✅ 索引数量合理（不过多避免insert性能问题）
- ✅ 外键自动生成的索引已考虑

**输出物**: 索引设计文档

---

### T4: 建表SQL脚本编写（1.5小时）

**目标**: 编写完整的CREATE TABLE SQL脚本

**实现文件**: `init-database.sql`

**脚本包含**:
1. 数据库创建（DROP DATABASE IF EXISTS）
2. 字符集配置（UTF8MB4）
3. 所有表的CREATE TABLE语句
4. 所有主键、外键、唯一键定义
5. 幂等性处理（DROP TABLE IF EXISTS）

**脚本结构**:
```sql
-- 头部：说明和参数设置
-- Part 1: 数据库创建
-- Part 2: 表结构定义
  -- 2.1 role表
  -- 2.2 user表
  -- 2.3 user_role表
  -- ... 其他表
-- Part 3: 初始化数据
-- Part 4: 验证脚本
```

**验证标准**:
- ✅ SQL语法正确，能编译通过
- ✅ 脚本支持多次执行（幂等性）
- ✅ 所有表、约束、索引都包含
- ✅ 字符集为UTF8MB4，排序规则为utf8mb4_unicode_ci

**输出物**: init-database.sql

**使用方法**:
```bash
# 命令行执行
mysql -h localhost -u root -p < init-database.sql

# 或在MySQL客户端中
mysql> source init-database.sql;
```

---

### T5: 索引脚本编写（0.5小时）

**目标**: 编写索引创建脚本（可选，通常包含在建表脚本中）

**注意**: 索引已在CREATE TABLE语句中定义，无需单独脚本

**如果需要后补索引**:
```sql
-- 示例：添加缺失的索引
ALTER TABLE user ADD INDEX idx_username(username);
ALTER TABLE report ADD INDEX idx_creator_id(creator_id);
ALTER TABLE audit_log ADD INDEX idx_created_at(created_at);
```

**验证标准**:
- ✅ 索引创建语法正确
- ✅ 索引能成功创建

---

### T6: 初始化数据脚本编写（1小时）

**目标**: 编写初始化数据的INSERT脚本

**初始化数据**:

1. **角色初始化** (3条)
   ```sql
   INSERT INTO role (role_name, description) VALUES
     ('ADMIN', '系统管理员'),
     ('DESIGNER', '报表设计者'),
     ('VIEWER', '普通用户');
   ```

2. **用户初始化** (3条用于测试)
   ```sql
   INSERT INTO user (username, password, email, status) VALUES
     ('admin', '$2a$10$...(bcrypt密码)', 'admin@example.com', 1),
     ('designer', '$2a$10$...', 'designer@example.com', 1),
     ('viewer', '$2a$10$...', 'viewer@example.com', 1);
   ```

3. **用户角色初始化** (3条)
   ```sql
   INSERT INTO user_role (user_id, role_id) VALUES
     (1, 1),  -- admin → ADMIN角色
     (2, 2),  -- designer → DESIGNER角色
     (3, 3);  -- viewer → VIEWER角色
   ```

**密码生成**:
使用BCrypt加密，不存储明文密码
```java
// Java示例
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
String hashed = encoder.encode("admin123");
// 结果: $2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcg7b3XeKeUxWdeS86E36P4/Ksm
```

**验证标准**:
- ✅ 所有初始化数据都插入成功
- ✅ 外键关系正确
- ✅ 密码已加密存储

---

### T7: 本地测试验证（1小时）

**目标**: 在本地MySQL验证脚本执行结果

**测试环境**:
- MySQL 5.7+ 或 MySQL 8.0+
- 本地安装或Docker容器

**本地安装MySQL示例** (Windows):
```powershell
# 使用Docker运行MySQL
docker run --name mysql57 `
  -e MYSQL_ROOT_PASSWORD=root `
  -p 3306:3306 `
  -d mysql:5.7

# 或使用本地安装的MySQL
mysql --version  # 检查版本
```

**执行脚本**:
```bash
# 方法1：命令行执行
mysql -h localhost -u root -p < init-database.sql

# 方法2：MySQL客户端执行
mysql -h localhost -u root -p
mysql> source init-database.sql;
```

**验证检查清单**:

1. ✅ **数据库创建成功**
   ```sql
   SHOW DATABASES LIKE 'programmer_report';
   ```

2. ✅ **所有表创建成功**
   ```sql
   USE programmer_report;
   SHOW TABLES;
   -- 应显示：role, user, user_role, report, report_param, report_column, report_role, audit_log
   ```

3. ✅ **表结构正确**
   ```sql
   DESCRIBE user;  -- 检查字段和类型
   SHOW CREATE TABLE user\G  -- 查看完整定义
   ```

4. ✅ **索引创建成功**
   ```sql
   SHOW INDEX FROM user;  -- 检查user表的索引
   SHOW INDEX FROM audit_log;  -- 检查audit_log表的索引
   ```

5. ✅ **初始化数据正确**
   ```sql
   SELECT * FROM role;  -- 应显示3条角色
   SELECT * FROM user;  -- 应显示3个测试用户
   SELECT * FROM user_role;  -- 应显示3条关联
   ```

6. ✅ **外键约束生效**
   ```sql
   -- 尝试删除一个有相关记录的用户，应提示外键冲突
   DELETE FROM user WHERE id = 1;  -- 可能失败（如果有report.creator_id引用）
   ```

7. ✅ **时区和字符集正确**
   ```sql
   SHOW VARIABLES LIKE 'character_set%';  -- 应为utf8mb4
   SHOW VARIABLES LIKE 'time_zone';  -- 应为UTC
   ```

**常见问题**:

| 问题 | 原因 | 解决 |
|------|------|------|
| 1054 Unknown column | 字段名拼写错误 | 检查SQL脚本中的字段定义 |
| 1215 Cannot add foreign key constraint | 外键引用的表不存在或类型不匹配 | 检查表创建顺序和字段类型 |
| 1366 Incorrect string value | 字符编码问题 | 检查character_set设置 |
| 1045 Access denied | 用户名密码错误 | 检查MySQL root密码 |

**输出物**: 测试验证报告

---

### T8: 幂等性处理（0.5小时）

**目标**: 确保脚本可以安全地重复执行多次

**幂等性设计**:

1. **使用DROP IF EXISTS**
   ```sql
   DROP TABLE IF EXISTS audit_log;  -- 先删除，避免"表已存在"错误
   DROP TABLE IF EXISTS report_role;
   -- ... 反向依赖顺序删除
   ```

2. **表创建后要清空时使用TRUNCATE而非DROP**
   ```sql
   -- 仅重置数据，保留表结构和索引
   TRUNCATE TABLE role;
   TRUNCATE TABLE user;
   -- 注意：先删除有FK的表的数据
   ```

3. **测试重复执行**
   ```bash
   # 执行一次
   mysql -h localhost -u root -p < init-database.sql
   
   # 立即再执行一次（应该成功，不报错）
   mysql -h localhost -u root -p < init-database.sql
   ```

**验证标准**:
- ✅ 脚本可执行多次，不报"表已存在"错误
- ✅ 重复执行后数据一致

---

### T9: 数据字典编写（1小时）

**目标**: 编写完整的数据库数据字典文档

**输出物**: `数据库数据字典.md`

**文档包含**:
1. 每个表的详细说明
   - 用途
   - 字段清单（类型、约束、说明）
   - 索引
   - 初始化数据
   - 业务规则
   - 容量估算

2. 表间关系
   - ER图
   - 外键关系说明
   - 级联规则说明

3. 索引设计
   - 所有索引的列表
   - 性能优化建议

4. 容量和性能规划
   - 各表的容量估算（1年）
   - 性能预期

5. 安全和约束
   - 数据安全措施
   - 业务约束

6. 维护建议
   - 定期维护任务
   - 备份和恢复方法
   - 常见问题排查

**编写示例**:
参考文件: `数据库数据字典.md`

**验证标准**:
- ✅ 文档完整，包含所有表和字段说明
- ✅ 业务规则和约束清晰
- ✅ 容量规划合理
- ✅ 易于理解，便于团队参考

---

### T10: 生产环境验证（1小时）

**目标**: 在测试/生产环境验证脚本可执行，准备部署

**环境准备** (假设Docker):

1. **创建测试环境数据库**
   ```bash
   docker run --name mysql-test `
     -e MYSQL_ROOT_PASSWORD=testpass `
     -p 3307:3306 `  # 使用不同端口，避免与本地冲突
     -d mysql:5.7
   ```

2. **在测试环境执行脚本**
   ```bash
   mysql -h 127.0.0.1 -P 3307 -u root -ptestpass < init-database.sql
   ```

3. **验证** (与T7相同的检查清单)
   ```sql
   mysql -h 127.0.0.1 -P 3307 -u root -ptestpass
   mysql> USE programmer_report;
   mysql> SHOW TABLES;
   mysql> SELECT * FROM role;
   ```

4. **性能基准测试**
   ```sql
   -- 测试登录查询性能（使用idx_username）
   EXPLAIN SELECT * FROM user WHERE username = 'admin';
   -- 应显示：key=idx_username （表示使用了索引）
   
   -- 测试日志查询性能
   EXPLAIN SELECT * FROM audit_log WHERE created_at >= '2025-01-01';
   -- 应显示：key=idx_created_at
   ```

5. **数据备份**
   ```bash
   # 备份初始化后的数据库
   mysqldump -h 127.0.0.1 -P 3307 -u root -ptestpass programmer_report > backup-init.sql
   ```

**生产部署检查清单**:
- ✅ 所有表创建成功
- ✅ 所有索引创建成功
- ✅ 初始化数据完整
- ✅ 外键约束生效
- ✅ 密码加密存储
- ✅ 性能基准达到预期
- ✅ 数据备份就绪

---

## ✅ 任务验收标准

### 代码阶段验收

- [ ] SQL脚本编写完成，语法正确
- [ ] 脚本通过本地验证，所有表创建成功
- [ ] 脚本支持幂等性，可重复执行
- [ ] 索引齐全，性能优化
- [ ] 初始化数据完整（3个角色、3个用户）

### 文档阶段验收

- [ ] 数据字典编写完成，清晰易懂
- [ ] ER图绘制正确，关系明确
- [ ] 表结构定义文档完整
- [ ] 索引设计文档详细

### 部署阶段验收

- [ ] 脚本在测试环境执行成功
- [ ] 脚本在生产环境执行成功
- [ ] 所有索引生效，查询性能达到预期
- [ ] 备份和恢复流程测试成功

---

## 📅 实施日程（1.3天）

### Day 1 (6小时)

| 时间 | 任务 | 工作量 | 状态 |
|------|------|--------|------|
| 09:00-10:00 | T1: ER图设计 | 1h | 开始 |
| 10:00-11:30 | T2: 表结构定义 | 1.5h | 进行中 |
| 11:30-12:30 | T3: 索引设计 | 1h | 进行中 |
| 13:30-15:00 | T4: 建表SQL编写 | 1.5h | 进行中 |
| 15:00-15:30 | T5: 索引脚本 | 0.5h | 进行中 |

### Day 2 (4.3小时)

| 时间 | 任务 | 工作量 | 状态 |
|------|------|--------|------|
| 09:00-10:00 | T6: 初始化数据 | 1h | 开始 |
| 10:00-11:00 | T7: 本地测试 | 1h | 进行中 |
| 11:00-11:30 | T8: 幂等性处理 | 0.5h | 进行中 |
| 11:30-12:30 | T9: 数据字典编写 | 1h | 进行中 |
| 13:30-14:30 | T10: 生产环境验证 | 1h | 进行中 |

---

## 🔗 相关文件

| 文件名 | 说明 |
|--------|------|
| init-database.sql | 数据库初始化脚本（核心交付物） |
| 数据库数据字典.md | 数据库文档（核心交付物） |
| TS-001-实施指南.md | 本文档 |
| Must-Have用户故事详细清单.md | 需求文档 |
| Sprint-Backlog-任务拆解与估算.md | 整体规划 |

---

## 🚀 快速开始

**最快执行TS-001的方法** (总耗时 ~2小时):

```bash
# 1. 查看SQL脚本
cat doc/sql/init-database.sql

# 2. 启动本地MySQL (Docker)
docker run --name mysql -e MYSQL_ROOT_PASSWORD=root -p 3306:3306 -d mysql:5.7

# 3. 等待MySQL启动 (约30秒)
sleep 30

# 4. 执行初始化脚本
docker exec mysql mysql -u root -proot < doc/sql/init-database.sql

# 5. 验证
docker exec mysql mysql -u root -proot -e "USE programmer_report; SHOW TABLES; SELECT * FROM role;"

# 6. 完成！现在可以开发其他功能了
```

---

## 💡 最佳实践

### 1. 版本控制
```bash
# SQL脚本应该版本控制
git add doc/sql/init-database.sql
git commit -m "feat(db): TS-001 初始化数据库表结构"
```

### 2. 脚本备份
```bash
# 备份初始脚本，以防误操作
cp init-database.sql init-database.backup-$(date +%Y%m%d).sql
```

### 3. 文档同步
```bash
# 修改表结构时同时更新文档
# 1. 修改init-database.sql
# 2. 执行验证
# 3. 更新数据字典.md
# 4. 提交变更
```

### 4. 定期维护
```bash
# 检查表大小
SELECT table_name, ROUND((data_length + index_length) / 1024 / 1024, 2) AS size_mb
FROM information_schema.tables
WHERE table_schema = 'programmer_report';

# 检查慢查询
SHOW VARIABLES LIKE 'slow_query_log%';
SHOW VARIABLES LIKE 'long_query_time%';
```

---

## 📞 常见问题Q&A

**Q1: 脚本执行失败，显示"Unknown column"**  
A: 检查SQL脚本中的字段名拼写，确保与表结构定义一致。可以使用以下命令找出问题：
```sql
mysql> SHOW CREATE TABLE user\G
```

**Q2: 如何修改已创建的表结构？**  
A: 使用ALTER TABLE语句，但要在设计端仔细评估：
```sql
ALTER TABLE user ADD COLUMN phone VARCHAR(20);
ALTER TABLE user MODIFY COLUMN email VARCHAR(150);
```

**Q3: 如何导出和导入数据库？**  
A: 使用mysqldump工具：
```bash
# 导出
mysqldump -u root -p programmer_report > backup.sql

# 导入
mysql -u root -p < backup.sql
```

**Q4: 能否修改已初始化的密码？**  
A: 可以，使用UPDATE语句（但需要先生成新的BCrypt密码）：
```sql
UPDATE user SET password = '$2a$10$...' WHERE username = 'admin';
```

**Q5: 初始化数据中的密码如何修改？**  
A: 修改init-database.sql中的INSERT语句，替换password字段的BCrypt值，然后重新执行脚本。

---

## 📝 参考资源

- [MySQL 官方文档](https://dev.mysql.com/doc/)
- [BCrypt密码加密](https://en.wikipedia.org/wiki/Bcrypt)
- [MySQL索引优化](https://dev.mysql.com/doc/refman/5.7/en/optimization-indexes.html)
- [数据库设计规范](https://www.1nf.org/)

---

**文档版本**: v1.0  
**最后更新**: 2025-12-26  
**作者**: AI Database Architect  

**🎯 下一步**: T7本地测试通过后，可以开始 US-014 (登录认证) 的开发

