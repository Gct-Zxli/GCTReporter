# 代码审查规范

> 适用于GCT Reporter项目的代码审查（Code Review）

---

## 📋 目录

- [审查流程](#审查流程)
- [审查清单](#审查清单)
- [定义完成DoD](#定义完成dod)
- [审查指南](#审查指南)
- [常见问题](#常见问题)

---

## 审查流程

### 1. 提交者职责

#### 创建PR前

```bash
# 1. 确保分支最新
git checkout develop
git pull origin develop
git checkout feature/US001-user-login
git rebase develop

# 2. 运行所有检查
mvn clean verify        # 后端：编译+测试+覆盖率
npm run lint            # 前端：代码检查
npm run test           # 前端：单元测试

# 3. 推送到远程
git push origin feature/US001-user-login
```

#### 创建PR

1. **填写PR标题**
   - 格式：`[Story-ID] 功能描述`
   - 示例：`[US001] 实现用户登录功能`

2. **使用PR模板**
   - 描述改动内容
   - 勾选自检清单
   - 提供测试说明

3. **关联Issue**
   - 使用 `Closes #123` 或 `Related to #456`

4. **指定审查人员**
   - 至少1人（小改动）
   - 2-3人（核心功能）

5. **添加标签**
   - `enhancement` - 新功能
   - `bug` - Bug修复
   - `documentation` - 文档更新

#### 响应审查意见

```bash
# 1. 根据意见修改代码
git add .
git commit -m "refactor: 根据审查意见优化代码"

# 2. 推送更新
git push origin feature/US001-user-login

# 3. 在PR中回复每条评论
- ✅ "已修改"
- 📝 "已补充注释"
- 💬 "关于这个问题，我的理解是..."

# 4. 解决后标记为Resolved

# 5. 重新请求审查
```

---

### 2. 审查者职责

#### 审查时机

- **及时响应**：收到审查请求后24小时内开始审查
- **分批审查**：优先审查小的PR（<200行）
- **深度审查**：核心功能需要更仔细的审查

#### 审查步骤

```bash
# 1. 拉取PR分支到本地
git fetch origin
git checkout feature/US001-user-login

# 2. 查看改动
git diff develop

# 3. 运行项目
mvn spring-boot:run     # 后端
npm run dev            # 前端

# 4. 运行测试
mvn test               # 后端测试
npm run test          # 前端测试

# 5. 手工测试核心功能
```

#### 提供反馈

**好的反馈示例**：

```markdown
### 问题1：命名不清晰
**位置**: UserService.java, 第42行

**问题**: 
方法名 `process()` 不够清晰，无法表达具体功能。

**建议**:
改为 `validateUserCredentials()` 更准确。

**优先级**: P1（必须修复）
```

```markdown
### 建议1：可以优化性能
**位置**: ReportController.java, 第58行

**当前代码**:
\`\`\`java
for (Report r : allReports) {
    if (r.getName().equals(name)) {
        return r;
    }
}
\`\`\`

**优化建议**:
可以使用 `reportRepository.findByName(name)` 直接查询，
避免加载所有数据。

**优先级**: P2（建议优化）
```

**避免的反馈方式**：

```markdown
❌ "这里不对"               → 太模糊
❌ "这段代码很糟糕"          → 不专业
❌ "为什么要这样写？"        → 太质疑
✅ "建议使用...方法，因为..." → 具体且有建设性
```

#### 审查优先级

| 优先级 | 说明 | 示例 | 处理 |
|--------|------|------|------|
| **P0** | 阻塞性问题，必须修复 | 安全漏洞、数据泄露 | PR不能合并 |
| **P1** | 重要问题，强烈建议修复 | 逻辑错误、性能问题 | 修复后合并 |
| **P2** | 一般建议 | 代码风格、命名优化 | 可以后续优化 |
| **P3** | 可选建议 | 更好的实现方式 | 供参考 |

---

## 审查清单

### 功能性审查

- [ ] **功能完整性**
  - [ ] 实现了所有验收标准（AC）
  - [ ] 边界条件处理正确
  - [ ] 错误处理完善
  
- [ ] **业务逻辑**
  - [ ] 逻辑正确，符合业务规则
  - [ ] 无明显的设计缺陷
  - [ ] 考虑了并发场景

### 代码质量审查

- [ ] **可读性**
  - [ ] 代码结构清晰
  - [ ] 命名清晰、有意义
  - [ ] 注释充分且准确
  - [ ] 无过度复杂的嵌套
  
- [ ] **可维护性**
  - [ ] 无重复代码（DRY原则）
  - [ ] 单一职责（SRP原则）
  - [ ] 模块化良好
  - [ ] 易于扩展

- [ ] **编码规范**
  - [ ] 符合项目编码规范
  - [ ] 代码已格式化
  - [ ] 无编译警告
  - [ ] 无遗留TODO/FIXME

### 测试审查

- [ ] **测试覆盖**
  - [ ] 单元测试覆盖率达标（后端≥80%，前端≥60%）
  - [ ] 测试用例合理
  - [ ] 边界测试完整
  - [ ] 异常场景测试充分
  
- [ ] **测试质量**
  - [ ] 测试独立，无依赖关系
  - [ ] 测试命名清晰
  - [ ] 断言准确
  - [ ] 测试运行通过

### 安全审查

- [ ] **SQL安全**
  - [ ] 使用参数化查询
  - [ ] 无SQL注入风险
  - [ ] SQL关键字校验
  
- [ ] **权限控制**
  - [ ] API接口有权限注解
  - [ ] 权限控制正确
  - [ ] 无权限绕过漏洞
  
- [ ] **数据安全**
  - [ ] 敏感数据已加密
  - [ ] 密码不记录到日志
  - [ ] 无硬编码密钥

### 性能审查

- [ ] **数据库查询**
  - [ ] 使用了适当的索引
  - [ ] 无N+1查询问题
  - [ ] 避免全表扫描
  - [ ] 使用了分页
  
- [ ] **资源使用**
  - [ ] 无内存泄漏
  - [ ] 文件/连接正确关闭
  - [ ] 大文件处理使用流式读取

### 文档审查

- [ ] **代码注释**
  - [ ] 类注释完整
  - [ ] 公共方法有JavaDoc
  - [ ] 复杂逻辑有注释说明
  
- [ ] **API文档**
  - [ ] Swagger注解完整
  - [ ] 接口说明清晰
  - [ ] 参数说明完整
  
- [ ] **其他文档**
  - [ ] README更新（如需要）
  - [ ] 数据库变更记录（如需要）
  - [ ] 配置说明更新（如需要）

---

## 定义完成（DoD）

每个用户故事必须满足以下标准才算完成：

### 开发层面

- [ ] ✅ 代码编写完成并通过编译
- [ ] ✅ 代码符合编码规范
  - 后端：遵循阿里巴巴Java开发手册
  - 前端：遵循Vue 3官方风格指南
- [ ] ✅ 代码已提交到功能分支
- [ ] ✅ 无编译警告
- [ ] ✅ 无遗留的TODO/FIXME（必须处理的）

### 测试层面

- [ ] ✅ 单元测试编写并通过
  - 后端覆盖率≥80%
  - 前端覆盖率≥60%
- [ ] ✅ 集成测试通过
- [ ] ✅ 满足所有验收标准（AC）
- [ ] ✅ 手工测试通过
- [ ] ✅ 边界和异常场景测试通过

### 质量层面

- [ ] ✅ 代码审查通过（至少1人Review）
- [ ] ✅ 所有审查意见已处理
- [ ] ✅ 无P0/P1级别Bug
- [ ] ✅ 性能测试达标
  - 查询<3秒
  - 导出<5秒
  - 列表加载<1秒
- [ ] ✅ 安全检查通过
  - 无SQL注入
  - 权限控制正确
  - 敏感数据已加密

### 文档层面

- [ ] ✅ API文档已更新（Swagger注解）
- [ ] ✅ 用户文档已更新（如需要）
- [ ] ✅ 数据库变更已记录（如需要）
  - Flyway迁移脚本
  - 数据字典更新
- [ ] ✅ 配置文件说明已更新（如需要）

### 部署层面

- [ ] ✅ 代码已合并到develop分支
- [ ] ✅ CI/CD流水线通过
- [ ] ✅ 数据库迁移脚本已准备（如需要）
- [ ] ✅ 配置文件已准备（如需要）
- [ ] ✅ 发布说明已准备（如需要）

### 沟通层面

- [ ] ✅ 相关人员已通知
  - 产品经理（功能验收）
  - 测试人员（测试准备）
  - 运维人员（部署准备）
- [ ] ✅ 风险点已识别并沟通

---

## 审查指南

### 审查时长

| PR规模 | 改动行数 | 建议审查时长 |
|--------|---------|------------|
| **XS** | <50行 | 10-15分钟 |
| **S** | 50-200行 | 20-30分钟 |
| **M** | 200-500行 | 30-60分钟 |
| **L** | 500-1000行 | 1-2小时 |
| **XL** | >1000行 | 建议拆分 |

### 审查频率

- **每天审查PR**：至少检查1-2次
- **及时响应**：24小时内给出初步反馈
- **优先级排序**：
  1. 阻塞其他开发的PR
  2. 小的PR（快速审查）
  3. 大的PR（分时段审查）

### 审查技巧

#### 1. 从高到低审查

```
1. 架构设计      → 是否合理
2. 业务逻辑      → 是否正确
3. 代码实现      → 是否优雅
4. 代码细节      → 命名、格式
```

#### 2. 关注重点

- **新增代码** > 修改代码 > 删除代码
- **核心逻辑** > 辅助代码
- **安全相关** > 功能实现

#### 3. 使用审查工具

- **GitHub/GitLab**：在线审查
- **IDE对比**：本地对比差异
- **Gerrit**：专业代码审查工具（可选）

---

## 常见问题

### Q1: PR太大怎么办？

**A**: 建议拆分为多个小PR：

```
# 不好：一个巨大的PR
feature/US001-complete-user-system (1500行)

# 好：拆分为多个小PR
feature/US001-1-user-entity (200行)
feature/US001-2-user-service (300行)
feature/US001-3-user-controller (200行)
feature/US001-4-user-tests (400行)
```

### Q2: 审查意见有分歧怎么办？

**A**: 
1. 线上讨论：在PR评论中充分交流
2. 线下沟通：会议或视频讨论
3. 第三方介入：技术负责人裁决
4. 记录决策：在ADR文档中记录

### Q3: 审查发现重大问题怎么办？

**A**: 
1. 明确标注为P0问题
2. 立即通知提交者
3. PR标记为"需要重大修改"
4. 必要时拒绝合并，要求重新设计

### Q4: 非功能性改进要不要提？

**A**: 
- P0/P1问题：必须提
- P2/P3建议：
  - 如果是小改动，可以提
  - 如果需要大规模重构，记录到Issue，后续处理

### Q5: 审查通过后发现问题怎么办？

**A**: 
1. 立即创建Bug Issue
2. 根据严重程度决定：
   - P0：立即hotfix
   - P1：当前Sprint修复
   - P2/P3：记录到Backlog
3. 团队复盘：分析为什么没在审查中发现

---

## 审查示例

### 好的审查评论示例

```markdown
### 💡 建议：使用Stream API优化

**文件**: UserService.java  
**行数**: 45-52

**当前实现**:
\`\`\`java
List<String> usernames = new ArrayList<>();
for (User user : users) {
    if (user.isEnabled()) {
        usernames.add(user.getUsername());
    }
}
\`\`\`

**优化建议**:
\`\`\`java
List<String> usernames = users.stream()
    .filter(User::isEnabled)
    .map(User::getUsername)
    .collect(Collectors.toList());
\`\`\`

**理由**: Stream API更简洁，可读性更好。

**优先级**: P2（建议优化）
```

### 一般的审查流程示例

```markdown
## 审查意见

### ✅ 功能实现
- 登录功能实现正确
- 错误处理完善
- 单元测试覆盖充分

### 🐛 问题

#### P1: 密码加密问题
**位置**: UserService.java#L23  
**问题**: 密码未加密直接存储  
**修复**: 使用BCryptPasswordEncoder加密

#### P2: 日志级别不当
**位置**: LoginController.java#L45  
**问题**: 使用info级别记录失败登录  
**建议**: 改为warn级别

### 💬 建议

#### 命名优化
**位置**: UserRepository.java#L15  
**建议**: `findByU`改为`findByUsername`更清晰

### 总结
- 2个P1问题需要修复
- 1个P2建议建议采纳
- 修复后可以合并

**审查人**: 张三  
**审查时间**: 2026-01-15 14:30
```

---

**最后更新**：2026-01-15  
**适用版本**：v1.0-MVP
